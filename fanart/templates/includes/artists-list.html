<%--
ajax_listartists.jsp
Lists a selection of artists according to the specified listing method. Invoked via the View Artists tab.
--%>

<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="tags" tagdir="/WEB-INF/tags" %>

<sql:setDataSource dataSource="jdbc/Fanart" />

<c:set var="start" value="0" />
<c:set var="count" value="0" />
<c:catch var="catchException">
<fmt:parseNumber var="start" value="${param.start}" integerOnly="true" />
<fmt:parseNumber var="count" value="${param.count}" integerOnly="true" />
</c:catch>
<c:set var="querycount" value="${count + 1}" />

<c:if test="${param.list == 'search' && start == 0}">

	<form name="searchform" onSubmit="listArtists('search',10);return false;">
	<input class="std" name="searchtext" id="searchtext" value="${param.term}" />
	<button type="submit">Search</button>
	</form>

</c:if>

a: {{ artists }}
<c:if test="${param.list != null && count > 0}">

	<c:set var="artistcount" value="10" />

	<c:choose>
	<c:when test="${param.list == 'name' && param.initial != null}">

		<sql:query var="qryArtists">
		SELECT artistid,artistname,dirname,examplepic,created,numpictures,lastupload,(numfavepics/numpictures)*numfaves as rating FROM artists
		WHERE enabled=true
		AND active=true
		AND numpictures>0
		AND sortname LIKE "${param.initial}%"
		${hideprivate}
		ORDER BY name DESC
		LIMIT ${start},${querycount}
		</sql:query>

	</c:when>
	<c:when test="${param.list == 'newest'}">

		<sql:query var="qryArtists">
		SELECT artistid,artistname,dirname,examplepic,created,numpictures,lastupload,(numfavepics/numpictures)*numfaves as rating FROM artists
		WHERE enabled=true
		AND active=true
		AND numpictures>0
		${hideprivate}
		ORDER BY created DESC
		LIMIT ${start},${querycount}
		</sql:query>

		<c:set var="shownumber" value="true" />

	</c:when>
	<c:when test="${param.list == 'recentactive'}">

		<sql:query var="qryArtists">
		SELECT artistid,artistname,dirname,examplepic,created,numpictures,lastupload,(numfavepics/numpictures)*numfaves as rating FROM artists
		WHERE enabled=true
		AND active=true
		AND numpictures>0
		${hideprivate}
		ORDER BY lastupload DESC
		LIMIT ${start},${querycount}
		</sql:query>

		<c:set var="shownumber" value="true" />

	</c:when>
	<c:when test="${param.list == 'toprated'}">

		<sql:query var="qryArtists">
		SELECT artistid,artistname,dirname,examplepic,created,numpictures,lastupload,(numfavepics/numpictures)*numfaves as rating FROM artists
		WHERE enabled=true
		AND active=true
		AND numpictures>0
		${hideprivate}
		ORDER BY rating DESC
		LIMIT ${start},${querycount}
		</sql:query>
		
		<c:set var="shownumber" value="true" />

	</c:when>
	<c:when test="${param.list == 'topratedactive'}">

		<sql:query var="qryArtists">
		SELECT artistid,artistname,dirname,examplepic,created,numpictures,lastupload,(numfavepics/numpictures)*numfaves as rating FROM artists
		WHERE enabled=true
		AND active=true
		AND numpictures>0
		AND lastupload>date_sub(now(),interval 1 month)
		${hideprivate}
		ORDER BY rating DESC
		LIMIT ${start},${querycount}
		</sql:query>

		<c:set var="shownumber" value="true" />

	</c:when>
	<c:when test="${param.list == 'prolific'}">

		<sql:query var="qryArtists">
		SELECT artistid,artistname,dirname,examplepic,created,numpictures,lastupload,(numfavepics/numpictures)*numfaves as rating FROM artists
		WHERE enabled=true
		AND active=true
		AND numpictures>0
		${hideprivate}
		ORDER BY numpictures DESC
		LIMIT ${start},${querycount}
		</sql:query>
		
		<c:set var="shownumber" value="true" />

	</c:when>
	<c:when test="${param.list == 'random'}">

		<sql:query var="qryArtists">
		SELECT artistid,artistname,dirname,examplepic,created,numpictures,lastupload,(numfavepics/numpictures)*numfaves as rating FROM artists
		WHERE enabled=true
		AND active=true
		AND numpictures>0
		${hideprivate}
		ORDER BY rand()
		LIMIT ${querycount}
		</sql:query>
		
		<c:set var="artistcount" value="5" />

	</c:when>
	<c:when test="${param.list == 'search' && param.term != null && param.term != ''}">

		<sql:query var="qryArtists">
		SELECT * FROM artists
		WHERE enabled=true
		AND active=true
		AND numpictures>0
		AND artistname LIKE "%${param.term}%"
		${hideprivate}
		ORDER BY sortname
		LIMIT ${start},${querycount}
		</sql:query>
		
	</c:when>
	<c:otherwise>

		<c:set var="nolist" value="1" />

	</c:otherwise>
	</c:choose>


	<c:set var="artistnumber" value="${start}" />

        {% for artist in artists %}

                {% include "includes/artist.html" %}

                {% if forloop.counter == count %}

			<c:if test="${nolist != 1}">
			<br clear="all" />
			<button onClick="getMoreArtists(${start + artistcount},'${param.list}',${artistcount},'${param.term}',this)">More</button>
			</c:if>

                {% endif %}

        {% endfor %}

</c:if>
