{% load humanize %}
{% load bbcode_tags %}
<%--
ajax_listcharacters.jsp
Lists a selection of characters according to the specified listing method. Invoked via the View Characters tab.
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fanart" uri="http://fanart.lionking.org/jsp/jstl/fanart" %>
<%@ taglib prefix="tags" tagdir="/WEB-INF/tags" %>

<sql:setDataSource dataSource="jdbc/Fanart" />

<c:catch var="catchException">
<fmt:parseNumber var="page" value="${param.page}" integerOnly="true" />
</c:catch>

<c:choose>
<c:when test="${param.list != null}">

	<%!
	  Hashtable Pages;
	%>

	<c:set var="charactercount" value="10" />

	<c:choose>
	<c:when test="${param.list == 'artist' && param.term != null}">

		<c:catch var="catchException">
		<fmt:parseNumber var="term" value="${param.term}" integerOnly="true" />
		</c:catch>

		<c:if test="${term > 0}">

		<sql:query var="qryCharactersFull">
		SELECT *
		FROM artists,characters
		WHERE characters.artistid=artists.artistid
		AND characters.artistid=?
		AND enabled=true
		AND active=true
		AND numpictures>0
		AND characters.deleted IS NULL
		${hideprivate}
		<sql:param value="${term}" />
		</sql:query>

		<c:set var="numItems" value="${qryCharactersFull.rowCount} " />
		<c:choose>
		<c:when test="${page > 0}">
		<c:set var="page" value="${page} " />
		</c:when>
		<c:otherwise>
		<c:set var="page" value="1 " />
		</c:otherwise>
		</c:choose>
		<%
		  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
		  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

		  Pages = pagesLink(numItems,50,pageNum,false,"","text",request.getQueryString());

		  pageContext.setAttribute("offset",Pages.get("offset"));
		  pageContext.setAttribute("thispage",Pages.get("thispage"));
		  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
		%>

		<sql:query var="qryCharacters">
		SELECT characters.*,artistname,dirname,basename,extension
		FROM artists,characters
		LEFT JOIN pictures ON profilepic=pictureid
		WHERE characters.artistid=artists.artistid
		AND characters.artistid=?
		AND enabled=true
		AND active=true
		AND numpictures>0
		AND characters.deleted IS NULL
		${hideprivate}
		ORDER BY charactername
		LIMIT ${offset},${thispage}
		<sql:param value="${term}" />
		</sql:query>

		<%= Pages.get("pages") %>
		${qryCharactersFull.rowCount} characters total.

		</c:if>

	</c:when>
	<c:when test="${param.list == 'species' && param.term != null && param.term != ''}">

		<c:set var="term" value="${fn:replace(param.term,'\"','\\\\\"')}" />

		<sql:query var="qryCharactersFull">
		SELECT characterid
		FROM artists,characters
		WHERE characters.artistid=artists.artistid
		<c:choose>
		<c:when test="${param.match == 'exact'}">
		AND species = "${term}"
		</c:when>
		<c:otherwise>
		AND species LIKE "%${term}%"
		</c:otherwise>
		</c:choose>
		AND enabled=true
		AND active=true
		AND numpictures>0
		AND characters.deleted IS NULL
		${hideprivate}
		</sql:query>

		<c:set var="numItems" value="${qryCharactersFull.rowCount} " />
		<c:choose>
		<c:when test="${page > 0}">
		<c:set var="page" value="${page} " />
		</c:when>
		<c:otherwise>
		<c:set var="page" value="1 " />
		</c:otherwise>
		</c:choose>
		<%
		  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
		  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

		  Pages = pagesLink(numItems,50,pageNum,false,"","text",request.getQueryString());

		  pageContext.setAttribute("offset",Pages.get("offset"));
		  pageContext.setAttribute("thispage",Pages.get("thispage"));
		  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
		%>

		<sql:query var="qryCharacters">
		SELECT characters.*,artistname,dirname,basename,extension
		FROM artists,characters
		LEFT JOIN pictures ON profilepic=pictureid
		WHERE characters.artistid=artists.artistid
		<c:choose>
		<c:when test="${param.match == 'exact'}">
		AND species = "${term}"
		</c:when>
		<c:otherwise>
		AND species LIKE "%${term}%"
		</c:otherwise>
		</c:choose>
		AND enabled=true
		AND active=true
		AND numpictures>0
		AND characters.deleted IS NULL
		${hideprivate}
		ORDER BY charactername
		LIMIT ${offset},${thispage}
		</sql:query>

		<%= Pages.get("pages") %>
		${qryCharactersFull.rowCount} characters total.

	</c:when>
	<c:when test="${param.list == 'charactername' && param.term != null && param.term != ''}">

		<c:set var="term" value="${fn:replace(param.term,'\"','\\\\\"')}" />

		<sql:query var="qryCharactersFull">
		SELECT characterid
		FROM artists,characters
		WHERE characters.artistid=artists.artistid
		<c:choose>
		<c:when test="${param.match == 'exact'}">
		AND charactername = "${term}"
		</c:when>
		<c:otherwise>
		AND charactername LIKE "%${term}%"
		</c:otherwise>
		</c:choose>
		AND enabled=true
		AND active=true
		AND numpictures>0
		AND characters.deleted IS NULL
		${hideprivate}
		</sql:query>

		<c:set var="numItems" value="${qryCharactersFull.rowCount} " />
		<c:choose>
		<c:when test="${page > 0}">
		<c:set var="page" value="${page} " />
		</c:when>
		<c:otherwise>
		<c:set var="page" value="1 " />
		</c:otherwise>
		</c:choose>
		<%
		  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
		  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

		  Pages = pagesLink(numItems,50,pageNum,false,"","text",request.getQueryString());

		  pageContext.setAttribute("offset",Pages.get("offset"));
		  pageContext.setAttribute("thispage",Pages.get("thispage"));
		  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
		%>

		<sql:query var="qryCharacters">
		SELECT characters.*,artistname,dirname,basename,extension
		FROM artists,characters
		LEFT JOIN pictures ON profilepic=pictureid
		WHERE characters.artistid=artists.artistid
		<c:choose>
		<c:when test="${param.match == 'exact'}">
		AND charactername = "${term}"
		</c:when>
		<c:otherwise>
		AND charactername LIKE "%${term}%"
		</c:otherwise>
		</c:choose>
		AND enabled=true
		AND active=true
		AND numpictures>0
		AND characters.deleted IS NULL
		${hideprivate}
		ORDER BY charactername
		LIMIT ${offset},${thispage}
		</sql:query>

		<%= Pages.get("pages") %>
		${qryCharactersFull.rowCount} characters total.

	</c:when>
	<c:when test="${param.list == 'mosttagged'}">

		<sql:query var="qryCharacters">
		SELECT characters.*,artistname,dirname,basename,extension,count(picturecharacters.characterid) AS tag_count
		FROM characters
		INNER JOIN picturecharacters ON picturecharacters.characterid=characters.characterid
		INNER JOIN artists ON characters.artistid=artists.artistid
		LEFT JOIN pictures ON characters.profilepic=pictures.pictureid
		WHERE characters.deleted IS NULL
		GROUP BY picturecharacters.characterid
		ORDER BY tag_count DESC
		LIMIT 100
		</sql:query>

	</c:when>
	<c:when test="${param.list == 'recentlytagged'}">

		<sql:query var="qryCharacters">
                SELECT characters_tagged.*,artistname,dirname,basename,extension,unix_timestamp(characters_tagged.max_tagged_on) as max_tagged_on_epoch
                FROM (select characters.*,max(tagged_on) as max_tagged_on FROM characters
	                INNER JOIN picturecharacters ON picturecharacters.characterid=characters.characterid
	                GROUP BY characterid) AS characters_tagged
                LEFT JOIN artists ON characters_tagged.artistid=artists.artistid
                LEFT JOIN pictures ON characters_tagged.profilepic=pictures.pictureid
		WHERE characters_tagged.deleted IS NULL
                ORDER BY max_tagged_on DESC
		LIMIT 100
		</sql:query>

	</c:when>
	</c:choose>


	<c:forEach var="character" items="${qryCharacters.rows}">

		<div class="character">
		<table>
		<tr>
			<td class="thumb"><a href="{% url "character" character_id=character.id %}">

                        <img class="thumb characterpic" src="{{ character.preview_url }}" />

			</a></td>
			<td class="fullwidth">
				<p class="charactername">
					<a href="{% url "character" character_id=character.id %}">{{ character.name }}</a>
				</p>
                                {% if character.owner %}
				<c:if test="${character.artistid != null}">
				<p class="characterinfo">
                                    {% if character.owner.is_artist and character.owner.dir_name %}
					Owner: <a href="{% url "artist" dir_name=character.owner.dir_name %}">{{ character.owner.username }}</a>
                                    {% else %}
					Owner: {{ character.owner.username }}
                                    {% endif %}
				</p>
				</c:if>
                                {% endif %}
                                {% if character.story_title %}
				<p class="characterinfo">
                                        {% if character.story_url %}
						Debut: <i><a href="{{ character.story_url }}">{{ character.story_title }}</a></i>
                                        {% else %}
						Debut: <i>{{ character.story_title }}</i>
                                        {% endif %}
				</p>
                                {% endif %}
				<p class="characterinfo">
                                    {{ character.gender|capfirst }}
                                    {{ character.species }}
				</p>
                                {% if character.picturecharacter_set.count > 0 %}
				<c:if test="${character.tag_count > 0}">
				<p class="characterinfo">
					Tagged in {{ character.picturecharacter_set.count }} pictures
				</p>
				</c:if>
                                {% endif %}
                                {% if character.last_tagged %}
				<p class="characterinfo">
					Tagged {{ character.last_tagged.date_tagged|naturaltime }}
				</p>
                                {% endif %}
				<div class="characterdesc">
                                        {{ character.description|bbcode|safe }}
				</div>

			</td>
		</tr>
		</table>
		</div>
	</c:forEach>

	<c:catch var="catchException">
	<%= Pages.get("pages") %>
	</c:catch>

</c:when>
<c:otherwise>
</c:otherwise>
</c:choose>
