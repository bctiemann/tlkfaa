{% extends "artmanager/base.html" %}
{% load bbcode_tags %}

{% block am_content %}

<%--
inc_artwork.jsp
ArtManager component for managing your pictures. Note that folderid -1 is the synthetic Coloring Cave "folder".
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" import="java.util.*,java.io.*" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fanart" uri="http://fanart.lionking.org/jsp/jstl/fanart" %>

<c:set var="basepath" value="${basepath}" scope="page" />

<sql:setDataSource dataSource="jdbc/Fanart"   />

<c:catch var="catchException">
<fmt:parseNumber var="pictureid" value="${param.pictureid}" integerOnly="true" />
<fmt:parseNumber var="folderid" value="${param.folderid}" integerOnly="true" />
<fmt:parseNumber var="newfolderid" value="${param.newfolderid}" integerOnly="true" />
<fmt:parseNumber var="page" value="${param.page}" integerOnly="true" />
</c:catch>
<c:if test="${page == null || page < 1}"><c:set var="page" value="1" /></c:if>


<c:if test="${loggedin == 1}">

<c:if test="${folderid == null}">
<c:set var="folderid" value="0" />
</c:if>

<c:choose>
<c:when test="${param.fnc == 'delete'}">

	<c:forEach var="deletepic" items="${fn:split(param.picturelist, ',')}">

	<c:set var="pic" value="0" />
	<c:catch var="catchException">
	<fmt:parseNumber var="pic" value="${deletepic}" integerOnly="true" />
	</c:catch>

	<c:if test="${pic > 0}">

		<sql:query var="qryPicture">
		SELECT * FROM pictures
		WHERE pictureid=?
		AND artistid=?
		AND deleted IS NULL
		<sql:param value="${pic}" />
		<sql:param value="${artist.artistid}" />
		</sql:query>

		<c:forEach var="picture" items="${qryPicture.rows}">

			Deleting ${picture.pictureid}...

			<sql:update var="updNewPics">
			DELETE FROM newpics
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:update var="updNewPicsPending">
			DELETE FROM newpics_pending
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:update var="updFavePics">
			DELETE FROM favepics
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:update var="updComments">
			UPDATE comments
			SET deleted=1
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:update var="updContestVotes">
			DELETE FROM contestvotes
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:update var="updContestPics">
			DELETE FROM contestpics
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:update var="updCCPic">
			UPDATE coloring_base
			SET active=false
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:update var="updCharacters">
			UPDATE characters
			SET profilepic=0
			WHERE profilepic=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:update var="updArtist">
			UPDATE artists
			SET examplepic=0
			WHERE examplepic=?
			<sql:param value="${pic}" />
			</sql:update>

			<sql:query var="qryRequests">
			SELECT * FROM requests,artists
			WHERE requests.recptid=artists.artistid
			AND pictureid=?
			<sql:param value="${pic}" />
			</sql:query>

			<c:forEach var="request" items="${qryRequests.rows}">

				Removing request for ${request.artistname}...<br />

				<sql:update var="updRequest">
				DELETE FROM requests 
				WHERE requestid=?
				<sql:param value="${request.requestid}" />
				</sql:update>

			</c:forEach>

			<sql:query var="qryPictureTags">
			SELECT * FROM picturetags
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:query>

			<c:forEach var="tag" items="${qryPictureTags.rows}">

				<sql:update var="updTag">
				UPDATE tags
				SET numpictures=numpictures-1
				WHERE tagid=?
				<sql:param value="${tag.tagid}" />
				</sql:update>

			</c:forEach>

			<%-- Clear tagged characters --%>
			<sql:update var="updPictureCharacters">
			DELETE FROM picturecharacters
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<%-- Delete the picture --%>
			<sql:update var="updPicture">
			UPDATE pictures
			SET deleted=NOW()
			WHERE pictureid=?
			<sql:param value="${pic}" />
			</sql:update>

			<%-- Update picture count for the artist --%>
			<sql:query var="qryNumPicsArtist">
			SELECT * FROM pictures
			WHERE artistid=?
			AND deleted IS NULL
			<sql:param value="${artist.artistid}" />
			</sql:query>
			<sql:update var="updNumPicsArtist">
			UPDATE artists SET numpictures=?
			WHERE artistid=?
			<sql:param value="${qryNumPicsArtist.rowCount}" />
			<sql:param value="${artist.artistid}" />
			</sql:update>

			<%-- Update picture count for this folder --%>
			<c:if test="${picture.folderid > 0}">
				<sql:query var="qryNumPicsFolder">
				SELECT * FROM pictures
				WHERE folderid=?
				AND deleted IS NULL
				<sql:param value="${picture.folderid}" />
				</sql:query>
				<sql:update var="updNumPicsFolder">
				UPDATE folders SET numpictures=?
				WHERE folderid=?
				<sql:param value="${qryNumPicsFolder.rowCount}" />
				<sql:param value="${picture.folderid}" />
				</sql:update>
			</c:if>

			<c:set var="artistid" value="${artist.artistid}" />
			<c:set var="pictureid" value="${pic}" />
			<c:set var="dirname" value="${artist.dirname}" />
			<c:set var="basename" value="${picture.basename}" />
			<c:set var="extension" value="${picture.extension}" />
			<%
                          String artistid = (String)pageContext.getAttribute("artistid").toString();
                          String pictureid = (String)pageContext.getAttribute("pic").toString();
			  String basepath = (String)pageContext.getAttribute("basepath");
			  String dirname = (String)pageContext.getAttribute("dirname");
			  String basename = (String)pageContext.getAttribute("basename");
			  String extension = (String)pageContext.getAttribute("extension");

			  File f = new File(basepath + "/Artwork/Artists/" + dirname + "/" + basename + "." +extension);
			  File ft = new File(basepath + "/Artwork/Artists/" + dirname + "/" + basename + ".s.jpg");
			  File fp = new File(basepath + "/Artwork/Artists/" + dirname + "/" + basename + ".p.jpg");

			  f.delete();
			  ft.delete();
			  fp.delete();

                          printLog("Artist " + artistid + " deleted picture " + basename + "." + extension + " (ID " + pictureid + ").");
			%>

			<c:set var="thisfolder" value="${picture.folderid}" />

		</c:forEach>

	</c:if>

	</c:forEach>

	<sql:query var="qryFolderPics">
	SELECT pictureid FROM pictures
	WHERE artistid=?
	AND folderid=?
	AND deleted IS NULL
	ORDER BY uploaded
	<sql:param value="${artist.artistid}" />
	<sql:param value="${thisfolder}" />
	</sql:query>
	<c:set var="i" value="0" />
	<c:forEach var="picture" items="${qryFolderPics.rows}">
		<c:set var="i" value="${i+1}" />
		<sql:update var="updFolderPic">
		UPDATE pictures SET
		rankinfolder=?
		WHERE pictureid=?
		<sql:param value="${i}" />
		<sql:param value="${picture.pictureid}" />
		</sql:update>
	</c:forEach>

	<sql:query var="qryArtistPics">
	SELECT pictureid FROM pictures
	WHERE artistid=?
	AND deleted IS NULL
	ORDER BY uploaded
	<sql:param value="${artist.artistid}" />
	</sql:query>
	<c:set var="i" value="0" />
	<c:forEach var="picture" items="${qryArtistPics.rows}">
		<c:set var="i" value="${i+1}" />
		<sql:update var="updArtistPic">
		UPDATE pictures SET
		rankinartist=?
		WHERE pictureid=?
		<sql:param value="${i}" />
		<sql:param value="${picture.pictureid}" />
		</sql:update>
	</c:forEach>

<%--
	<%
	  String redirectURL = "/ArtManager.jsp?op=artwork";
	  response.sendRedirect(redirectURL);
	%>
--%>

</c:when>
<c:when test="${param.fnc == 'deletecc'}">

	<c:forEach var="deleteccpic" items="${fn:split(param.ccpiclist, ',')}">

	<c:set var="ccpic" value="0" />
	<c:catch var="catchException">
	<fmt:parseNumber var="pic" value="${deleteccpic}" integerOnly="true" />
	</c:catch>

	<c:if test="${pic > 0}">

		<sql:query var="qryCCPic">
		SELECT * FROM coloring_pics
		WHERE coloring_picid=?
		AND artistid=?
		<sql:param value="${pic}" />
		<sql:param value="${artist.artistid}" />
		</sql:query>

		<c:forEach var="ccpic" items="${qryCCPic.rows}">

			Deleting ${ccpic.coloring_picid}...

			<sql:update var="updCCPic">
			DELETE FROM coloring_pics
			WHERE coloring_picid=?
			AND artistid=?
			<sql:param value="${pic}" />
			<sql:param value="${artist.artistid}" />
			</sql:update>

			<sql:update var="updCCBase">
			UPDATE coloring_base
			SET numcolored=numcolored-1
			WHERE coloring_baseid=?
			<sql:param value="${ccpic.basepic}" />
			</sql:update>

			<sql:update var="updCharacters">
			UPDATE characters
			SET profilepic_c=0
			WHERE profilepic_c=?
			<sql:param value="${pic}" />
			</sql:update>

		</c:forEach>

	</c:if>

	</c:forEach>

</c:when>
<c:otherwise>
</c:otherwise>
</c:choose>


<h2>Your Artwork</h2>

Folder:
<select name="switchfolder" class="foldermenu" folderid="{{ folder.id }}" onChange="switchParam(this, 'folderid')">
    <option value="-1" {% if folder.id == -1 %}selected{% endif %}>(Coloring Cave)</option>
    <option value="0" {% if folder == None %}selected{% endif %}>(Main)</option>
</select>

{% if folder.id != -1 %}
<c:if test="${folderid != -1}">
Sort by:
<select name="sortby" onChange="switchParam(this, 'sortby')">
    <option {% if sort_by == "newest" %}selected{% endif %} value="newest">Newest</option>
    <option {% if sort_by == "oldest" %}selected{% endif %} value="oldest">Oldest</option>
    <option {% if sort_by == "popularity" %}selected{% endif %} value="popularity">Popularity</option>
    <option {% if sort_by == "comments" %}selected{% endif %} value="comments">Comments</option>
</select>
</c:if>
{% endif %}

<div class="globalactions actions-container">
	<a href="javascript:nop()"><div class="actions_hover" id="actions_global">All Selected</div></a>
	<div class="actions_menu" id="actions_global_popup">
	<h3>All Selected</h3>
	<c:choose>
	<c:when test="${folderid == -1}">
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="deleteCCPic(0)">Delete</a>
	</c:when>
	<c:otherwise>
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="deletePicture(0,${folderid},${page})">Delete</a>
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="setupMove(0,${folderid},${page})" id="movetofolderlink_0">Move to Folder<div class="movetofolder" id="movetofolder_0"></div></a>
	</c:otherwise>
	</c:choose>
	</div>
</div>

<div class="selectall"><input type="checkbox" name="selectall" onClick="toggleSelectAll(this)" /> Select all</div>

<%--<div class="picturestatus" id="picturestatus_0"></div>--%>
<div class="pictureiconstatus" id="pictureiconstatus_0"></div>

{% if folder.id == -1 %}
<c:choose>
<c:when test="${folderid == -1}">

	<sql:query var="qryCCPicsFull">
	SELECT * FROM coloring_base,coloring_pics,artists
	WHERE coloring_pics.basepic=coloring_base.coloring_baseid
	AND coloring_base.artistid=artists.artistid
	AND coloring_pics.artistid=?
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<c:set var="numItems" value="${qryCCPicsFull.rowCount} " />
	<c:choose>
	<c:when test="${page > 0}">
	<c:set var="page" value="${page} " />
	</c:when>
	<c:otherwise>
	<c:set var="page" value="1 " />
	</c:otherwise>
	</c:choose>
	<%
	  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
	  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

	  Hashtable Pages = pagesLink(numItems,20,pageNum,false,"","text",request.getQueryString());

	  pageContext.setAttribute("offset",Pages.get("offset"));
	  pageContext.setAttribute("thispage",Pages.get("thispage"));
	  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
	  pageContext.setAttribute("page",pageNum);
	%>

	<sql:query var="qryCCPics">
	SELECT * FROM coloring_base,coloring_pics,artists
	WHERE coloring_pics.basepic=coloring_base.coloring_baseid
	AND coloring_base.artistid=artists.artistid
	AND coloring_pics.artistid=?
	ORDER BY coloring_pics.posted ASC
	LIMIT ${offset},${thispage}
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<%= Pages.get("pages") %>

	<c:forEach var="ccpic" items="${qryCCPics.rows}">

		<div class="picture editpicture">
		<table>
		<tr>
		<td class="thumb">
		<input type="checkbox" id="select_${ccpic.coloring_picid}" /> Select<br />
		<a href="/Artwork/coloring/${ccpic.coloring_picid}.${ccpic.extension}" rel="shadowbox[pictures]"><img class="thumb" src="/Artwork/coloring/${ccpic.coloring_picid}.p.jpg" /></a>
		<div class="picturestats">
		<fmt:formatDate value="${ccpic.posted}" type="both" pattern="E M/d/yyyy" /><br />
		${ccpic.width} x ${ccpic.height}<br />
		</div>
		</td>
		<td class="fullwidth picturedetails">

		<div class="actions-container">
			<a href="javascript:nop()"><div class="actions_hover" id="actions_${ccpic.coloring_picid}">Actions</div></a>
			<div class="actions_menu" id="actions_${ccpic.coloring_picid}_popup">
				<h3>Actions</h3>
				<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="setupEditCCPic(${ccpic.coloring_picid})">Edit</a>
				<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="deleteCCPic(${ccpic.coloring_picid},${page})">Delete</a>
			</div>
		</div>

		<div class="picturedetails">

		<div id="editccpic_${ccpic.coloring_picid}">
		<jsp:include page="ajax_editccpic.jsp?ccpicid=${ccpic.coloring_picid}" />
		</div>

		<div>
		<a href="/ColoringCave.jsp?ccid=${ccpic.basepic}">View original</a> by <a href="/Artists/${ccpic.dirname}/">${ccpic.artistname}</a>
		</div>

		</div>
		</td>
		</tr>
		</table>
		</div>

		<script type="text/javascript">
		selitems.push(${ccpic.coloring_picid});
		</script>

	</c:forEach>

</c:when>
{% else %}
<c:otherwise>

	<c:choose>
	<c:when test="${param.sortby == 'newest'}">
		<c:set var="sortby" value="uploaded" />
		<c:set var="sortdir" value="DESC" />
	</c:when>
	<c:when test="${param.sortby == 'oldest'}">
		<c:set var="sortby" value="uploaded" />
		<c:set var="sortdir" value="ASC" />
	</c:when>
	<c:when test="${param.sortby == 'comments'}">
		<c:set var="sortby" value="numcomments" />
		<c:set var="sortdir" value="DESC" />
	</c:when>
	<c:when test="${param.sortby == 'popularity'}">
		<c:set var="sortby" value="numpicfaves" />
		<c:set var="sortdir" value="DESC" />
	</c:when>
	<c:otherwise>
		<c:set var="sortby" value="uploaded" />
		<c:set var="sortdir" value="DESC" />
	</c:otherwise>
	</c:choose>

	<sql:query var="qryPicturesFull">
	SELECT * FROM pictures
	WHERE artistid=?
	AND folderid=?
	AND deleted IS NULL
	<sql:param value="${artist.artistid}" />
	<sql:param value="${folderid}" />
	</sql:query>

	<c:set var="numItems" value="${qryPicturesFull.rowCount} " />
	<c:choose>
	<c:when test="${page > 0}">
	<c:set var="page" value="${page} " />
	</c:when>
	<c:otherwise>
	<c:set var="page" value="1 " />
	</c:otherwise>
	</c:choose>
	<%
	  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
	  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

	  Hashtable Pages = pagesLink(numItems,20,pageNum,false,"","text",request.getQueryString());

	  pageContext.setAttribute("offset",Pages.get("offset"));
	  pageContext.setAttribute("thispage",Pages.get("thispage"));
	  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
	  pageContext.setAttribute("page",pageNum);
	%>

	<c:choose>
	<c:when test="${folderid == 0}">
		<sql:query var="qryPictures">
		SELECT * FROM pictures
		WHERE artistid=?
		AND folderid IS NULL
		AND deleted IS NULL
	        ORDER BY ${sortby} ${sortdir}
		LIMIT ${offset},${thispage}
		<sql:param value="${artist.artistid}" />
		</sql:query>
	</c:when>
	<c:otherwise>
		<sql:query var="qryPictures">
		SELECT * FROM pictures
		WHERE artistid=?
		AND folderid=?
		AND deleted IS NULL
	        ORDER BY ${sortby} ${sortdir}
		LIMIT ${offset},${thispage}
		<sql:param value="${artist.artistid}" />
		<sql:param value="${folderid}" />
		</sql:query>
	</c:otherwise>
	</c:choose>

	<%= Pages.get("pages") %>

        {% for picture in pictures %}
	<c:forEach var="picture" items="${qryPictures.rows}">

		<sql:query var="qryReplacement">
		SELECT * FROM pending
		WHERE replacement=?
		AND artistid=?
		<sql:param value="${picture.pictureid}" />
		<sql:param value="${artist.artistid}" />
		</sql:query>

		<div class="picture editpicture {% if not picture.is_public %}privatepicture{% endif %}" id="picture_{{ picture.id }}">
		<table>
		<tr>
		<td class="thumb">
		<input type="checkbox" id="select_{{ picture.id }}" /> Select<br />
		<a href="{{ picture.url }}?{{ picture.id }}" rel="shadowbox[pictures]"><img class="thumb" src="{{ picture.preview_url }}" /></a>
		<div class="picturestats">
		{{ picture.date_uploaded|date:"D n/j/Y" }}<br />
		{{ picture.width }} x {{ picture.height }}<br />
                {{ picture.file_size|filesizeformat }}<br />
		{{ picture.num_comments }} comment{{ picture.num_comments|pluralize }}<br />
		<a href="javascript:nop()" onClick="togglePicFans({{ picture.id }})">{{ picture.num_faves }} favorite{{ picture.num_faves|pluralize }}</a><br />
		</div>
		</td>
		<td class="fullwidth picturedetails">

		<div class="actions-container">
			<a href="javascript:nop()"><div class="actions_hover" id="actions_{{ picture.id }}">Actions</div></a>
			<div class="actions_menu" id="actions_{{ picture.id }}_popup">
				<h3>Actions</h3>
				<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="setupEditPicture({{ picture.id }})">Edit</a>
                                {% if picture.replacement_pending %}
				<c:choose>
				<c:when test="${qryReplacement.rowCount > 0}">
					<a class="ui-state-default ui-corner-all ui-state-disabled" href="javascript:nop()">(Replacement Pending)</a>
				</c:when>
                                {% else %}
				<c:otherwise>
					<a class="ui-state-default ui-corner-all" href="{% url "artmanager:upload" %}?replace={{ picture.id }}">Replace</a>
				</c:otherwise>
				</c:choose>
                                {% endif %}
				<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="deletePicture({{ picture.id }},{{ folder.id }},{{ page }})">Delete</a>
				<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="setupRequest({{ picture.id }})">ArtWall</a>
				<a class="ui-state-default ui-corner-all" href="ArtManager.jsp?op=coloringcave&pictureid={{ picture.id }}">Coloring Cave</a>
				<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="setExamplePic({{ picture.id }})">Set as Icon</a>
				<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="setupMove({{ picture.id }},{{ folder.id }},{{ page }})" id="movetofolderlink_{{ picture.id }}">Move to Folder<div class="movetofolder" id="movetofolder_{{ picture.id }}"></div></a>
			</div>
		</div>

		<div class="picturedetails">

		<div id="editpicture_{{ picture.id }}">
                {% include "artmanager/picture_detail.html" %}
		<jsp:include page="ajax_editpicture.jsp?pictureid={{ picture.id }}" />
		</div>

		<div class="picturerequestsstatus" id="picturerequestsstatus_{{ picture.id }}">
		<jsp:include page="ajax_request.jsp?op=list&pictureid=${picture.pictureid}" />
		</div>

		<div class="picadmininfo pictureiconstatus" id="pictureiconstatus_{{ picture.id }}">
                {% if picture == user.example_pic %}
		<c:if test="{{ picture == artist.example_pic }">
		<jsp:include page="ajax_setexamplepic.jsp?pictureid=${picture.pictureid}" />
		</c:if>
                {% endif %}
		</div>

		<div class="picfans" id="picfans_{{ picture.id }}"></div>

		</div>
		</td>
		</tr>
		</table>
<%--
		<input type="hidden" name="fnc" value="apply" />
		<input type="hidden" name="pictureid" value="{{ picture.id }}" />
		<input type="hidden" name="op" value="pictures" />
		</form>
--%>
		</div>

		<script type="text/javascript">
		selitems.push({{ picture.id }});
		</script>

	</c:forEach>
        {% endfor %}

</c:otherwise>
</c:choose>
{% endif %}

</c:if>


<div class="dialog" id="dialog_select_destination_folder" title="Select Destination Folder">
<select id="select_destination_folder" class="foldermenu" folderid="{{ folder.id }}" onchange="">
    <option value="0" <c:if test="${folderid == 0}">selected</c:if>>(Main)</option>
</select>
</div>

<input type="hidden" id="edit_artistid" value="{{ user.id }}" />

{% endblock %}
