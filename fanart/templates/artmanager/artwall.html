{% extends "artmanager/base.html" %}
{% load bbcode_tags %}

{% block am_content %}

<%--
inc_requests.jsp
ArtManager component for managing the art trades/requests others have sent to you.
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fanart" uri="http://fanart.lionking.org/jsp/jstl/fanart" %>

<sql:setDataSource dataSource="jdbc/Fanart"   />

<c:catch var="catchException">
<fmt:parseNumber var="page" value="${param.page}" integerOnly="true" />
<fmt:parseNumber var="requestid" value="${param.requestid}" integerOnly="true" />
</c:catch>

<c:if test="${loggedin == 1}">

<c:choose>
<c:when test="${requestid > 0 && param.fnc == 'approve'}">

	<sql:query var="qryRequest">
	SELECT requests.*,artistname,dirname FROM requests,artists
	WHERE requests.active=false
	AND requestid=?
	AND recptid=?
	AND requests.artistid=artists.artistid
	<sql:param value="${requestid}" />
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<c:if test="${qryRequest.rowCount > 0}">
		<sql:update var="updRequest">
		UPDATE requests SET active=true
		WHERE requestid=?
		<sql:param value="${requestid}" />
		</sql:update>
	</c:if>	

</c:when>
<c:when test="${param.fnc == 'remove'}">

	<c:forEach var="deletereq" items="${fn:split(param.requestlist, ',')}">

		<c:catch var="catchException">
		<fmt:parseNumber var="req" value="${deletereq}" integerOnly="true" />
		</c:catch>

		<c:if test="${req > 0}">

			<sql:update var="updRequests">
			DELETE FROM requests
			WHERE requestid=?
			AND recptid=?
			<sql:param value="${req}" />
			<sql:param value="${artist.artistid}" />
			</sql:update>

			<c:set var="artistid" value="${artist.artistid}" />
			<c:set var="requestid" value="${req}" />
			<%
			        String artistid = pageContext.getAttribute("artistid").toString();
			        String requestid = pageContext.getAttribute("requestid").toString();
			        printLog("Artist " + artistid + " deleted request " + requestid + " from their own ArtWall.");
			%>

		</c:if>

	</c:forEach>

</c:when>
<c:otherwise>
</c:otherwise>
</c:choose>


<h2>Manage Your ArtWall</h2>

<sql:query var="qryRequestsFull">
SELECT * FROM pictures,requests,artists
WHERE requests.pictureid=pictures.pictureid
AND requests.artistid=artists.artistid
AND requests.recptid=?
AND pictures.deleted IS NULL
<sql:param value="${artist.artistid}" />
</sql:query>

<c:set var="numItems" value="${qryRequestsFull.rowCount} " />
<c:choose>
<c:when test="${page > 0}">
<c:set var="page" value="${page} " />
</c:when>
<c:otherwise>
<c:set var="page" value="0 " />
</c:otherwise>
</c:choose>
<%
  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

  Hashtable Pages = pagesLink(numItems,50,pageNum,true,"","text",request.getQueryString());

  pageContext.setAttribute("offset",Pages.get("offset"));
  pageContext.setAttribute("thispage",Pages.get("thispage"));
  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
%>

<sql:query var="qryRequests">
SELECT requestid,pictures.pictureid,basename,extension,uploaded,thumbheight,title,artists.artistname,artists.dirname,requests.active FROM pictures,requests,artists
WHERE requests.pictureid=pictures.pictureid
AND requests.artistid=artists.artistid
AND requests.recptid=?
AND pictures.deleted IS NULL
ORDER BY requests.active ASC,pictures.uploaded DESC
LIMIT ${offset},${thispage}
<sql:param value="${artist.artistid}" />
</sql:query>

<%= Pages.get("pages") %>

<div class="globalactions actions-container">
	<a href="javascript:nop()"><div class="actions_hover" id="actions_global">All Selected</div></a>
	<div class="actions_menu" id="actions_global_popup">
	<h3>All Selected</h3>
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="removeRequest(0)">Remove</a>
	</div>
</div>

<div class="selectall"><input type="checkbox" name="selectall" onClick="toggleSelectAll(this)" /> Select all</div>

<%-- Put pager here --%>
<div class="pageslink"></div>

<c:forEach var="request" items="${qryRequests.rows}">

	<sql:query var="qryRequestRecpts">
	SELECT * FROM requests
	WHERE pictureid=?
	AND recptid!=?
	<sql:param value="${request.pictureid}" />
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<div class="picture editpicture">
	<form name="editrequest_${request.requestid}" method="post" action="ArtManager.jsp">
	<table>
	<tr>
	<td class="thumb">
	<input type="checkbox" id="select_${request.requestid}" /> Select<br />
	<a href="/Artwork/Artists/${request.dirname}/${fanart:encodeURI(request.basename)}.${request.extension}?${request.pictureid}" rel="shadowbox[requests]"><img class="thumb" src="/Artwork/Artists/${request.dirname}/${fanart:encodeURI(request.basename)}.p.jpg" /></a>
	<div class="picturestats">
	<fmt:formatDate value="${request.uploaded}" type="both" pattern="E M/d/yyyy" /><br />
	</div>
	</td>
	<td class="fullwidth picturedetails">

	<a href="javascript:nop()"><div class="actions_hover" id="actions_${request.requestid}">Actions</div></a>
	<div class="actions_menu" id="actions_${request.requestid}_popup">
	<h3>Actions</h3>
	<c:if test="${request.active == false}">
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="approveRequest(1,document.requestform,${request.requestid})">Accept</a>
	</c:if>
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="removeRequest(${request.requestid})">Remove</a>
	</div>

	<div class="picturedetails">

	<div class="picartist"><a href="/Artists/${request.dirname}/">${request.artistname}</a></div>

	<c:set var="title" value="${request.title}" />
	<div class="pictitle">
	<%= formatText((String)pageContext.getAttribute("title")) %>
	</div>

	<c:if test="${request.active == false}">
	<div class="picadmininfo"><img src="/images/warning.png" /> You have not yet accepted this item. <a href="javascript:nop()" onClick="approveRequest(1,document.requestform,${request.requestid})">accept</a></div>
	</c:if>

	<c:if test="${qryRequestRecpts.rowCount > 0}">
	<div class="picadmininfo">(sent to ${qryRequestRecpts.rowCount} other recipients)</div>
	</c:if>

	</div>
	</td>
	</tr>
	</table>
	</form>
	</div>

	<script type="text/javascript">
	selitems.push(${request.requestid});
	$('#actions_${request.requestid}').popupmenu({
	    target: "#actions_${request.requestid}_popup",
	    time: 300 });
	</script>

</c:forEach>

<form name="requestform" method="POST" action="/ArtManager.jsp?op=requests">
<input type="hidden" name="op" value="requests" />
<input type="hidden" name="fnc" value="approve" />
<input type="hidden" name="approve" value="" />
<input type="hidden" name="requestid" value="" />
</form>

</c:if>

{% endblock %}
