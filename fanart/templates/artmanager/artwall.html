{% extends "artmanager/base.html" %}
{% load static %}
{% load bbcode_tags %}

{% block am_content %}

<%--
inc_requests.jsp
ArtManager component for managing the art trades/requests others have sent to you.
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fanart" uri="http://fanart.lionking.org/jsp/jstl/fanart" %>

<sql:setDataSource dataSource="jdbc/Fanart"   />

<c:catch var="catchException">
<fmt:parseNumber var="page" value="${param.page}" integerOnly="true" />
<fmt:parseNumber var="requestid" value="${param.requestid}" integerOnly="true" />
</c:catch>

<c:if test="${loggedin == 1}">

<c:choose>
<c:when test="${requestid > 0 && param.fnc == 'approve'}">

	<sql:query var="qryRequest">
	SELECT requests.*,artistname,dirname FROM requests,artists
	WHERE requests.active=false
	AND requestid=?
	AND recptid=?
	AND requests.artistid=artists.artistid
	<sql:param value="${requestid}" />
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<c:if test="${qryRequest.rowCount > 0}">
		<sql:update var="updRequest">
		UPDATE requests SET active=true
		WHERE requestid=?
		<sql:param value="${requestid}" />
		</sql:update>
	</c:if>	

</c:when>
<c:when test="${param.fnc == 'remove'}">

	<c:forEach var="deletereq" items="${fn:split(param.requestlist, ',')}">

		<c:catch var="catchException">
		<fmt:parseNumber var="req" value="${deletereq}" integerOnly="true" />
		</c:catch>

		<c:if test="${req > 0}">

			<sql:update var="updRequests">
			DELETE FROM requests
			WHERE requestid=?
			AND recptid=?
			<sql:param value="${req}" />
			<sql:param value="${artist.artistid}" />
			</sql:update>

			<c:set var="artistid" value="${artist.artistid}" />
			<c:set var="requestid" value="${req}" />
			<%
			        String artistid = pageContext.getAttribute("artistid").toString();
			        String requestid = pageContext.getAttribute("requestid").toString();
			        printLog("Artist " + artistid + " deleted request " + requestid + " from their own ArtWall.");
			%>

		</c:if>

	</c:forEach>

</c:when>
<c:otherwise>
</c:otherwise>
</c:choose>


<h2>Manage Your ArtWall</h2>

<sql:query var="qryRequestsFull">
SELECT * FROM pictures,requests,artists
WHERE requests.pictureid=pictures.pictureid
AND requests.artistid=artists.artistid
AND requests.recptid=?
AND pictures.deleted IS NULL
<sql:param value="${artist.artistid}" />
</sql:query>

<c:set var="numItems" value="${qryRequestsFull.rowCount} " />
<c:choose>
<c:when test="${page > 0}">
<c:set var="page" value="${page} " />
</c:when>
<c:otherwise>
<c:set var="page" value="0 " />
</c:otherwise>
</c:choose>
<%
  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

  Hashtable Pages = pagesLink(numItems,50,pageNum,true,"","text",request.getQueryString());

  pageContext.setAttribute("offset",Pages.get("offset"));
  pageContext.setAttribute("thispage",Pages.get("thispage"));
  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
%>

<sql:query var="qryRequests">
SELECT requestid,pictures.pictureid,basename,extension,uploaded,thumbheight,title,artists.artistname,artists.dirname,requests.active FROM pictures,requests,artists
WHERE requests.pictureid=pictures.pictureid
AND requests.artistid=artists.artistid
AND requests.recptid=?
AND pictures.deleted IS NULL
ORDER BY requests.active ASC,pictures.uploaded DESC
LIMIT ${offset},${thispage}
<sql:param value="${artist.artistid}" />
</sql:query>

<%= Pages.get("pages") %>

{{ pages_link.pages_nav|safe }}

<div class="globalactions actions-container">
	<a href="javascript:nop()"><div class="actions_hover" id="actions_global">All Selected</div></a>
	<div class="actions_menu" id="actions_global_popup">
	<h3>All Selected</h3>
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="removeRequest(0)">Remove</a>
	</div>
</div>

<div class="selectall"><input type="checkbox" name="selectall" onClick="toggleSelectAll(this)" /> Select all</div>

<%-- Put pager here --%>
<div class="pageslink"></div>

{% for gift_picture in gift_pictures %}
<c:forEach var="request" items="${qryRequests.rows}">

	<sql:query var="qryRequestRecpts">
	SELECT * FROM requests
	WHERE pictureid=?
	AND recptid!=?
	<sql:param value="${request.pictureid}" />
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<div class="picture editpicture">
	<form name="editrequest_{{ gift_picture.id }}" method="post">
	<table>
	<tr>
	<td class="thumb">
	<input type="checkbox" id="select_{{ gift_picture.id }}" /> Select<br />
	<a href="{{ gift_picture.picture.url }}?{{ gift_picture.picture.id }}" rel="shadowbox[requests]"><img class="thumb" src="{{ gift_picture.picture.preview_url }}" /></a>
	<div class="picturestats">
        {{ gift_picture.picture.date_uploaded|date }}<br />
	</div>
	</td>
	<td class="fullwidth picturedetails">

	<a href="javascript:nop()"><div class="actions_hover" id="actions_{{ gift_picture.id }}">Actions</div></a>
	<div class="actions_menu" id="actions_{{ gift_picture.id }}_popup">
	<h3>Actions</h3>
        {% if not gift_picture.is_active %}
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="approveRequest(1,document.requestform,{{ gift_picture.id }})">Accept</a>
        {% endif %}
	<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="removeRequest({{ gift_picture.id }})">Remove</a>
	</div>

	<div class="picturedetails">

	<div class="picartist"><a href="{% url "artist" dir_name=gift_picture.sender.dir_name %}">{{ gift_picture.sender.username }}</a></div>

	<div class="pictitle">
        {{ gift_picture.picture.title|bbcode|safe }}
	</div>

        {% if not gift_picture.is_active %}
	<div class="picadmininfo"><img src="{% static "images/warning.png" %}" /> You have not yet accepted this item. <a href="javascript:nop()" onClick="approveRequest(1,document.requestform,{{ gift_picture.id }})">accept</a></div>
        {% endif %}

	<c:if test="${qryRequestRecpts.rowCount > 0}">
	<div class="picadmininfo">(sent to ${qryRequestRecpts.rowCount} other recipients)</div>
	</c:if>

	</div>
	</td>
	</tr>
	</table>
	</form>
	</div>

	<script type="text/javascript">
	selitems.push({{ gift_picture.id }});
	$('#actions_{{ gift_picture.id }}').popupmenu({
	    target: "#actions_{{ gift_picture.id }}_popup",
	    time: 300 });
	</script>

</c:forEach>
{% endfor %}

<form name="requestform" method="POST" action="/ArtManager.jsp?op=requests">
<input type="hidden" name="op" value="requests" />
<input type="hidden" name="fnc" value="approve" />
<input type="hidden" name="approve" value="" />
<input type="hidden" name="requestid" value="" />
</form>

</c:if>

{% endblock %}
