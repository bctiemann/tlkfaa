{% extends "artmanager/base.html" %}
{% load bbcode_tags %}

{% block am_content %}

<%--
inc_characters.jsp
ArtManager component for managing your characters.
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fanart" uri="http://fanart.lionking.org/jsp/jstl/fanart" %>

<sql:setDataSource dataSource="jdbc/Fanart"   />

<c:catch var="catchException">
<fmt:parseNumber var="characterid" value="${param.characterid}" integerOnly="true" />
<fmt:parseNumber var="page" value="${param.page}" integerOnly="true" />
<fmt:parseNumber var="sex" value="${param.sex}" integerOnly="true" />
</c:catch>
<c:if test="${sex > 2 || sex < 0}"><c:set var="sex" value="0" /></c:if>

<c:if test="${loggedin == 1}">

<h2>Manage Your Characters</h2>

<c:choose>
<c:when test="${param.fnc == 'create'}">

	<c:if test="${param.charactername != ''}">

		<sql:update var="updCharacter">
		INSERT INTO characters (artistid,charactername,description,species,sex,storyname,storyurl,created,creator,lastmod) 
		VALUES (?,?,?,?,?,?,?,NOW(),?,NOW())
		<sql:param value="${artist.artistid}" />
		<sql:param value="${fn:substring(param.charactername,0,64)}" />
		<sql:param value="${param.description}" />
		<sql:param value="${fn:substring(param.species,0,64)}" />
		<sql:param value="${sex}" />
		<sql:param value="${fn:substring(param.storyname,0,100)}" />
		<sql:param value="${fn:substring(param.storyurl,0,100)}" />
		<sql:param value="${artist.artistid}" />
		</sql:update>

		<sql:query var="qryCharacters">
		SELECT * FROM characters
		WHERE artistid=?
		<sql:param value="${artist.artistid}" />
		</sql:query>
		<sql:update var="updArtist">
		UPDATE artists SET numcharacters=?
		WHERE artistid=?
		<sql:param value="${qryCharacters.rowCount}" />
		<sql:param value="${artist.artistid}" />
		</sql:update>

		Created.

	</c:if>

</c:when>
<c:when test="${param.fnc == 'delete' && characterid > 0}">

	Deleting character ${characterid}...

	<sql:query var="qryCharacter">
	SELECT * FROM characters
	WHERE characterid=?
	AND artistid=?
	<sql:param value="${characterid}" />
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<c:forEach var="character" items="${qryCharacter.rows}">

		<%-- Deactivate adoptables for this character --%>
		<sql:query var="qryAdoptables">
		SELECT * FROM offers
		WHERE type='adoptable'
		AND characterid=?
		<sql:param value="${characterid}" />
		</sql:query>

		<c:forEach var="offer" items="${qryAdoptables.rows}">

			<sql:update var="updAdoptable">
			UPDATE offers
			SET active=false,
			visible=false
			WHERE offerid=?
			<sql:param value="${offer.offerid}" />
			</sql:update>

		</c:forEach>

		<%-- Clear tagged pictures --%>
		<sql:update var="updPictureCharacter">
		DELETE FROM picturecharacters
		WHERE characterid=?
		<sql:param value="${characterid}" />
		</sql:update>

		<%-- Delete the character --%>
		<sql:update var="updCharacter">
		UPDATE characters SET deleted=NOW()
		WHERE characterid=?
		<sql:param value="${characterid}" />
		</sql:update>

	</c:forEach>

	<sql:query var="qryCharacters">
	SELECT * FROM characters
	WHERE artistid=?
	<sql:param value="${artist.artistid}" />
	</sql:query>
	<sql:update var="updArtist">
	UPDATE artists SET numcharacters=?
	WHERE artistid=?
	<sql:param value="${qryCharacters.rowCount}" />
	<sql:param value="${artist.artistid}" />
	</sql:update>

</c:when>
</c:choose>

<sql:query var="qryCharactersFull">
SELECT * FROM characters
WHERE artistid=?
AND deleted IS NULL
<sql:param value="${artist.artistid}" />
</sql:query>

<c:set var="numItems" value="${qryCharactersFull.rowCount} " />
<c:choose>
<c:when test="${page > 0}">
<c:set var="page" value="${page} " />
</c:when>
<c:otherwise>
<c:set var="page" value="1 " />
</c:otherwise>
</c:choose>
<%
  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

  Hashtable Pages = pagesLink(numItems,20,pageNum,false,"","text",request.getQueryString());

  pageContext.setAttribute("offset",Pages.get("offset"));
  pageContext.setAttribute("thispage",Pages.get("thispage"));
  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
%>

<sql:query var="qryCharacters">
SELECT characters.*,basename,extension FROM characters 
LEFT JOIN pictures ON profilepic=pictureid
WHERE characters.artistid=?
AND characters.deleted IS NULL
ORDER BY charactername
LIMIT ${offset},${thispage}
<sql:param value="${artist.artistid}" />
</sql:query>

<form name="characterform" id="characterform" method="POST" action="{% url "artmanager:character-create" %}">
<table class="formtable">
<tr>
<td class="label">Name</td>
<td class="data"><input type="text" class="std" name="name" maxlength="64" validate="hasvalue" message="You must enter a name for the character." /></td>
</tr>
<tr>
<td class="label">Description</td>
<td class="data"><textarea name="description"></textarea></td>
</tr>
<tr>
<td class="label">Species</td>
<td class="data"><input type="text" class="std" name="species" maxlength="64" /></td>
</tr>
<tr>
<td class="label">Sex</td>
<td class="data">
<select name="sex">
<option value="male">Male</option>
<option value="female">Female</option>
<option value="">Neither</option>
</select>
</td>
</tr>
<tr>
<td class="label">Origin Story Title</td>
<td class="data"><input type="text" class="std" name="story_title" maxlength="100" /></td>
</tr>
<tr>
<td class="label">Story URL</td>
<td class="data"><input type="text" class="std" name="story_url" maxlength="100" /></td>
</tr>
<tr>
<td colspan="2" class="buttons">
<button type="button" onClick="validateForm('characterform','document.characterform.submit()')">Create</button>
</td>
</tr>
</table>
<input type="hidden" name="op" value="characters" />
<input type="hidden" name="fnc" value="create" />
{% csrf_token %}
</form>


<%= Pages.get("pages") %>

{% for character in user.character_set.all %}
<c:forEach var="character" items="${qryCharacters.rows}">

	<sql:query var="qryAdoptedOut">
	SELECT * FROM offers
	WHERE type='adoptable'
	AND characterid=?
	AND active=true
	AND visible=true
	<sql:param value="${character.characterid}" />
	</sql:query>

	<c:set var="chardesc" value="${character.description}" />

	<div class="editcharacter">
	<table>
	<tr>
	<td>
	<a href="{% url "picture-picker" target="character" %}" onClick="document.pickpictureform.itemid.value={{ character.id }}" rel="shadowbox;width=500;height=600"><div id="pickpicture_{{ character.id }}">

		<img class="thumb characterpic" src="{{ character.preview_url }}" />

	</div></a>
	</td>
	<td class="characterinfo">
	<div class="characteredit">
	<a href="javascript:nop()" onClick="setupEditCharacter({{ character.id }})">edit</a>
	<a href="javascript:nop()" onClick="deleteCharacter({{ character.id }})">delete</a>
        {% if character.adoption_offer %}
	<c:choose>
	<c:when test="${qryAdoptedOut.rowCount > 0}">
		<c:forEach var="adoptable" items="${qryAdoptedOut.rows}">
			<a href="/ArtManager.jsp?op=tradingtree&offertype=adoptable&offerid=${adoptable.offerid}">Up for adoption</a>
		</c:forEach>
	</c:when>
        {% else %}
	<c:otherwise>
		<a href="/ArtManager.jsp?op=tradingtree&offertype=adoptable&characterid=${character.characterid}">adopt out</a>
	</c:otherwise>
	</c:choose>
        {% endif %}
	</div>

	<div id="editcharacter_{{ character.id }}">
                {% include "artmanager/character.html" %}
		<jsp:include page="/ajax_editcharacter.jsp?characterid=${character.characterid}" />
	</div>

	</td>
	</tr>
	</table>
	</div>

</c:forEach>
{% endfor %}

<form name="pickpictureform">
<input type="hidden" name="item" value="character" />
<input type="hidden" name="itemid" value="" />
<%--
<input type="hidden" name="pictureid" value="" />
<input type="hidden" name="picturetype" value="" />
--%>
</form>

</c:if>

{% endblock %}
