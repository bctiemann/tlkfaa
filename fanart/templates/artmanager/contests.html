{% extends "artmanager/base.html" %}
{% load bbcode_tags %}

{% block am_content %}

<%--
inc_contests.jsp
ArtManager component for managing your contests.
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="tags" tagdir="/WEB-INF/tags" %>

<sql:setDataSource dataSource="jdbc/Fanart"   />

<c:catch var="catchException">
<fmt:parseNumber var="contestid" value="${param.contestid}" integerOnly="true" />
<fmt:parseNumber var="pictureid" value="${param.pictureid}" integerOnly="true" />
<fmt:parseNumber var="allowvoting" value="${param.allowvoting}" integerOnly="true" />
</c:catch>
<c:if test="${allowvoting != 1}"><c:set var="allowvoting" value="0" /></c:if>

<c:if test="${loggedin == 1}">

<c:choose>
<c:when test="${artist.ispaid == false}">
<jsp:include page="inc_notpaidfeature.jsp" />
</c:when>
<c:otherwise>

<c:if test="${param.deadline_pick != null}">
	<%
	  String deadline_raw = request.getParameter("deadline_pick");
	  if (deadline_raw.length() > 0) {
	    String[] deadline = deadline_raw.split("/");
	    if (deadline.length == 3) {   
	      pageContext.setAttribute("deadline_year",deadline[2]);
	      pageContext.setAttribute("deadline_month",deadline[0]);
	      pageContext.setAttribute("deadline_day",deadline[1]);
	    }
	  }
	%>
	<c:if test="${deadline_year != null && deadline_month != null && deadline_day != null}">
		<c:set var="deadline" value="${deadline_year}-${deadline_month}-${deadline_day}" />
	</c:if>
</c:if>

<c:choose>
<c:when test="${param.fnc == 'create'}">

	<c:catch var="deadlineException">
		<sql:update var="updContest">
		INSERT INTO contests (type,artistid,title,description,rules,created,deadline,active,allowvoting)
		VALUES (?,?,?,?,?,NOW(),?,false,?)
		<sql:param value="personal" />
		<sql:param value="${artist.artistid}" />
		<sql:param value="${fn:substring(param.title,0,64)}" />
		<sql:param value="${param.description}" />
		<sql:param value="${param.rules}" />
		<sql:param value="${deadline}" />
		<sql:param value="${allowvoting}" />
		</sql:update>
	</c:catch>
	<c:if test="${deadlineException != null && deadline != null}">
		Invalid deadline.
	</c:if>

</c:when>
<c:when test="${param.fnc == 'edit' || param.fnc == 'publish'}">

	<c:catch var="deadlineException">
		<sql:update var="updContest">
		UPDATE contests SET 
		title=?,
		description=?,
		rules=?,
		<c:if test="${param.fnc == 'publish'}">
		startdate=NOW(),
		active=true,
		</c:if>
		deadline=?,
		allowvoting=?
		WHERE contestid=?
		AND artistid=?
		AND active=false
		<sql:param value="${fn:substring(param.title,0,64)}" />
		<sql:param value="${param.description}" />
		<sql:param value="${param.rules}" />
		<sql:param value="${deadline}"/>
		<sql:param value="${allowvoting}" />
		<sql:param value="${contestid}" />
		<sql:param value="${artist.artistid}" />
		</sql:update>
	</c:catch>
	<c:if test="${deadlineException != null && deadline != null}">
		Invalid deadline.
	</c:if>

</c:when>
<c:when test="${param.fnc == 'unpublish'}">

	<sql:update var="updContest">
	UPDATE contests SET 
	active=false
	WHERE contestid=?
	AND artistid=?
	<sql:param value="${contestid}" />
	<sql:param value="${artist.artistid}" />
	</sql:update>

</c:when>
<c:when test="${param.fnc == 'cancel'}">

	<sql:update var="updContest">
	UPDATE contests SET 
	cancelled=true,
	active=false
	WHERE contestid=?
	AND artistid=?
	<sql:param value="${contestid}" />
	<sql:param value="${artist.artistid}" />
	</sql:update>

</c:when>
<c:when test="${param.fnc == 'delete'}">

	<sql:query var="qryContest">
	SELECT * FROM contests
	WHERE contestid=?
	AND artistid=?
	<sql:param value="${contestid}" />
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<c:if test="${qryContest.rowCount > 0}">
		<sql:update var="updContestPics">
		DELETE FROM contestpics
		WHERE contestid=?
		<sql:param value="${contestid}" />
		</sql:update>

		<sql:update var="updContestVotes">
		DELETE FROM contestvotes
		WHERE contestid=?
		<sql:param value="${contestid}" />
		</sql:update>
	</c:if>

	<sql:update var="updContest">
	DELETE FROM contests
	WHERE contestid=?
	AND artistid=?
	<sql:param value="${contestid}" />
	<sql:param value="${artist.artistid}" />
	</sql:update>

</c:when>
<c:when test="${param.fnc == 'removepicture'}">

	<sql:query var="qryContest">
	SELECT * FROM contests
	WHERE contestid=?
	AND artistid=?
	<sql:param value="${contestid}" />
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<c:if test="${qryContest.rowCount > 0}">
		<sql:update var="updContestPic">
		DELETE FROM contestpics
		WHERE contestid=?
		AND pictureid=?
		<sql:param value="${contestid}" />
		<sql:param value="${pictureid}" />	
		</sql:update>

		<sql:update var="updContestPicVotes">
		DELETE FROM contestvotes
		WHERE contestid=?
		AND pictureid=?
		<sql:param value="${contestid}" />
		<sql:param value="${pictureid}" />	
		</sql:update>
	</c:if>

</c:when>
<c:otherwise>
</c:otherwise>
</c:choose>


	<h2>Manage Your Art Contests</h2>

	<h3 class="sectionheader">Create New Contest</h3>
	<div class="bulletin">

	<form name="contest_new" id="contest_new" method="POST" action="ArtManager.jsp">
	<table class="formtable">
	<tr>
	<td class="label">Contest Title</td>
	<td class="data"><input type="text" class="std" name="title" maxlength="64" validate="hasvalue" message="You must enter a title for the contest." /></td>
	</tr>
	<tr>
	<td class="label">Deadline</td>
	<td class="data"><input type="text" class="std" name="deadline_pick" id="deadline_pick_new" maxlength="255" validate="pattern" pattern="^[0-9]{1,2}/[0-9]{1,2}/[0-9]{1,4}$" message="You must specify the deadline for the contest in MM/DD/YYYY format." /></td>
	</tr>
	<tr>
	<td class="label">Allow Voting</td>
	<td class="data"><input type="checkbox" name="allowvoting" value="1" /></td>
	</tr>
	<tr>
	<td class="label">Theme/Description</td>
	<td class="data"><textarea name="description"></textarea></td>
	</tr>
	<tr>
	<td class="label">Rules</td>
	<td class="data"><textarea name="rules"></textarea></td>
	</tr>
	<tr>
	<td colspan="2" class="buttons">
	<button type="button" onClick="validateForm('contest_new','document.contest_new.submit()')">Create Contest</button>   
	</td>
	</tr>
	</table>
	<input type="hidden" name="op" value="contests" />
	<input type="hidden" name="fnc" value="create" />
	</form>
	</div>

	<script type="text/javascript">
		$('#deadline_pick_new').datepicker();
		$('#deadline_pick_new').datepicker("option", "dateFormat", "m/d/yy");
	</script>

	<h3 class="sectionheader">Unpublished Contests</h3>

	<sql:query var="qryContestsUnPub">
	SELECT * FROM contests
	WHERE artistid=?
	AND type=?
	AND active=false
	AND cancelled=false
	ORDER BY created DESC
	<sql:param value="${artist.artistid}" />
	<sql:param value="personal" />
	</sql:query>

	<c:forEach var="contest" items="${qryContestsUnPub.rows}">

	<div class="contest">
	<form name="contest_${contest.contestid}" id="contest_${contest.contestid}" method="POST" action="ArtManager.jsp">
	<table class="formtable">
	<tr>
	<td class="label">Contest Title</td>
	<c:set var="contesttitle" value="${contest.title}" />
	<td class="data"><input type="text" class="std" name="title" maxlength="64" value="<%= sanitizeHTML((String)pageContext.getAttribute("contesttitle"),64) %>" validate="hasvalue" message="The contest title cannot be blank." /></td>
	</tr>
	<tr>
	<td class="label">Deadline</td>
	<td class="data"><input type="text" class="std" name="deadline_pick" id="deadline_pick_${contest.contestid}" maxlength="255" value="<fmt:formatDate value="${contest.deadline}" type="date" pattern="M/d/yyyy" />" validate="pattern" pattern="^[0-9]{1,2}/[0-9]{1,2}/[0-9]{1,4}$" message="You must specify the deadline for the contest in MM/DD/YYYY format." /></td>
	</tr>
	<tr>
	<td class="label">Allow Voting</td>
	<td class="data"><input type="checkbox" name="allowvoting" value="1" <c:if test="${contest.allowvoting == true}">checked</c:if> /></td>
	</tr>
	<tr>
	<td class="label">Theme/Description</td>
	<td class="data"><textarea name="description">${contest.description}</textarea></td>
	</tr>
	<tr>
	<td class="label">Rules</td>
	<td class="data"><textarea name="rules">${contest.rules}</textarea></td>
	</tr>
	<tr>
	<td colspan="2" class="buttons">
	<button type="button" onClick="validateForm('contest_${contest.contestid}','document.contest_${contest.contestid}.submit()')">Apply Changes</button>
	<button type="button" onClick="validateForm('contest_${contest.contestid}','applyContest(document.contest_${contest.contestid},${contest.contestid},\'publish\')')">Publish and Begin Contest</button>
	<button type="button" onClick="applyContest(form,${contest.contestid},'delete')">Delete Contest</button>
	</td>
	</tr>
	</table>
	<input type="hidden" name="op" value="contests" />
	<input type="hidden" name="fnc" value="edit" />
	<input type="hidden" name="contestid" value="${contest.contestid}" />
	</form>
	</div>

	<script type="text/javascript">
		$('#deadline_pick_${contest.contestid}').datepicker();
		$('#deadline_pick_${contest.contestid}').datepicker("option", "dateFormat", "m/d/yy");
	</script>

	</c:forEach>


	<h3 class="sectionheader">Published Contests</h3>

	<sql:query var="qryContestsPub">
	SELECT * FROM contests
	WHERE artistid=?
	AND type=?
	AND active=true
	ORDER BY created DESC
	LIMIT 20
	<sql:param value="${artist.artistid}" />
	<sql:param value="personal" />
	</sql:query>
	
	<c:forEach var="contest" items="${qryContestsPub.rows}">

		<c:set var="description" value="${contest.description}" />
		<c:set var="rules" value="${contest.rules}" />

		<div class="contest">
		<form name="contest_${contest.contestid}" method="POST" action="ArtManager.jsp">

		<table class="formtable">
		<tr>
		<td class="label">Contest Title</td>
		<td class="data"><a href="/Contests.jsp?contestid=${contest.contestid}">${contest.title}</a></td>
		</tr>
		<tr>
		<td class="label">Deadline</td>
		<td class="data">
		<fmt:formatDate value="${contest.deadline}" type="date" pattern="M/d/yyyy" />
		</td>
		</tr>
		<tr>
		<td class="label">Voting</td>
		<td class="data">
		<c:choose>
		<c:when test="${contest.allowvoting == true}">
		Allowed
		</c:when>
		<c:when test="${contest.allowvoting == false}">
		Not Allowed
		</c:when>
		</c:choose>
		</td>
		</tr>
		<tr>
		<td class="label">Theme/Description</td>
		<td class="data"><%= formatText((String)pageContext.getAttribute("description")) %></td>
		</tr>
		<tr>
		<td class="label">Rules</td>
		<td class="data"><%= formatText((String)pageContext.getAttribute("rules")) %></td>
		</tr>
		<tr>
		<td colspan="2" class="buttons">
			<c:choose>
			<c:when test="${contest.cancelled}">
				(Cancelled)
			</c:when>
			<c:otherwise>
				<button type="button" onClick="applyContest(form,${contest.contestid},'unpublish')">Unpublish and Edit Contest</button>
				<button type="button" onClick="applyContest(form,${contest.contestid},'cancel')">Cancel Contest</button>
			</c:otherwise>
			</c:choose>
		</td>
		</tr>
		</table>
		<input type="hidden" name="op" value="contests" />
		<input type="hidden" name="fnc" value="" />
		<input type="hidden" name="contestid" value="${contest.contestid}" />
		<input type="hidden" name="pictureid" value="" />
		</form>
		</div>

		<sql:query var="qryContestPics">
		SELECT * FROM contestpics,pictures,artists
		WHERE contestpics.pictureid=pictures.pictureid
		AND pictures.artistid=artists.artistid
		AND contestpics.contestid=?
		ORDER BY entered
		<sql:param value="${contest.contestid}" />
		</sql:query>

		<c:forEach var="contestpic" items="${qryContestPics.rows}">

			<c:set var="title" value="${contestpic.title}" />
			<tags:printPicture
				picnumber=""
				pictureid="${contestpic.pictureid}"
				basename="${contestpic.basename}"
				extension="${contestpic.extension}"
				type="${contestpic.type}"
				title="<%= formatText((String)pageContext.getAttribute(\"title\")) %>"
				artistname="${contestpic.artistname}"
				dirname="${contestpic.dirname}"
				width="${contestpic.width}"
				height="${contestpic.height}"
				thumbheight="${contestpic.thumbheight}"
				allowcomments="${contestpic.allowcomments_p && contestpic.allowcomments}"
				numcomments="${contestpic.numcomments}"
				numpicfaves="${contestpic.numpicfaves}"
				gallery="contest-${contest.contestid}"
				folder="${contestpic.folderid}"
				contest="${contest.contestid}"
				contestform="document.contest_${contest.contestid}"
				contestremove="1"
				>
				<jsp:attribute name="uploaded">
					<fmt:formatDate value="${contestpic.uploaded}" type="both" pattern="HH:mm E M/d/yyyy" />
				</jsp:attribute>  
				<jsp:attribute name="filesize">
					<fmt:formatNumber value="${contestpic.filesize / 1024}" type="number" pattern="###" />
				</jsp:attribute>
			</tags:printPicture>

		</c:forEach>

	</c:forEach>

</c:otherwise>
</c:choose>

</c:if>

{% endblock %}
