{% extends "artmanager/base.html" %}
{% load bbcode_tags %}

{% block am_content %}

<%--
inc_comments.jsp
ArtManager component for managing the comments you've received and posted.
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fanart" uri="http://fanart.lionking.org/jsp/jstl/fanart" %>

<sql:setDataSource dataSource="jdbc/Fanart" />

<c:catch var="catchException">
<fmt:parseNumber var="page" value="${param.page}" integerOnly="true" />
</c:catch>

<c:if test="${loggedin == 1}">

<c:choose>
<c:when test="${artist.active == true}">
	<c:set var="type" value="received" />
	<c:if test="${param.type == 'posted'}">
	<c:set var="type" value="posted" />
	</c:if>
</c:when>
<c:otherwise>
	<c:set var="type" value="posted" />
</c:otherwise>
</c:choose>

<c:set var="showall" value="1" />
<c:if test="${param.showall != 1}">
<c:set var="showallclause" value="AND viewed=false" />
<c:set var="showall" value="0" />
</c:if>


<c:if test="${param.fnc == 'markread'}">

	<c:forEach var="markcomment" items="${fn:split(param.itemlist, ',')}">
		<c:set var="comment" value="0" />
		<c:catch var="catchException">
		<fmt:parseNumber var="comment" value="${markcomment}" integerOnly="true" />
		</c:catch>
		<c:if test="${comment > 0}">
		<sql:query var="qryComment">
		SELECT * FROM comments,pictures
		WHERE comments.pictureid=pictures.pictureid
		AND commentid=?
		AND artistid=?
		<sql:param value="${comment}" />
		<sql:param value="${artist.artistid}" />
		</sql:query>
		<c:forEach var="comment" items="${qryComment.rows}">
			<sql:update var="updComment">
			UPDATE comments SET
			viewed=true
			WHERE commentid=?
			<sql:param value="${comment.commentid}" />
			</sql:update>
		</c:forEach>
		</c:if>
	</c:forEach>

</c:if>


<h2>Your Comments</h2>

<c:if test="${artist.active == true}">
<div class="selector_commentview">
<div class="selector">
<a class="<c:if test="${type == 'posted'}">selected</c:if>" href="/ArtManager.jsp?op=comments&type=posted">posted</a>
<a class="<c:if test="${type == 'received'}">selected</c:if>" href="/ArtManager.jsp?op=comments&type=received">received</a>
</div>
<c:if test="${type == 'received'}">
	<div class="selector">
	View: <a class="<c:if test="${showall == 0}">selected</c:if>" href="/ArtManager.jsp?op=comments&type=${type}&showall=0">unread</a>
	<a class="<c:if test="${showall == 1}">selected</c:if>" href="/ArtManager.jsp?op=comments&type=${type}&showall=1">all</a>
	</div>
</c:if>
<br clear="left" />
</div>
</c:if>

<c:choose>
<c:when test="${type == 'posted'}">

	<sql:query var="qryCommentsFull">
	SELECT * FROM comments
	WHERE userid=?
	<sql:param value="${user.userid}" />
	</sql:query>

	<c:set var="numItems" value="${qryCommentsFull.rowCount} " />
	<c:choose>
	<c:when test="${page > 0}"> 
	<c:set var="page" value="${page} " />
	</c:when>
	<c:otherwise>
	<c:set var="page" value="0 " />
	</c:otherwise>
	</c:choose>
	<%
	  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
	  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

	  Hashtable Pages = pagesLink(numItems,50,pageNum,true,"","text",request.getQueryString());

	  pageContext.setAttribute("offset",Pages.get("offset"));
	  pageContext.setAttribute("thispage",Pages.get("thispage"));
	  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
	%>

	<sql:query var="qryComments">
	SELECT * FROM comments
	WHERE userid=?
	ORDER BY posted DESC
	LIMIT ${offset},${thispage}
	<sql:param value="${user.userid}" />
	</sql:query>

	<%= Pages.get("pages") %>

	<c:forEach var="comment" items="${qryComments.rows}">

		<sql:query var="qryPictures">
		SELECT pictures.*,artists.artistname,artists.dirname FROM pictures,artists
		WHERE pictureid=?
		AND pictures.artistid=artists.artistid
		AND pictures.deleted IS NULL
		<sql:param value="${comment.pictureid}" />
		</sql:query>

		<c:forEach var="picture" items="${qryPictures.rows}">

		<form name="editcomment_${comment.commentid}">
		<div class="comment" id="comment_${comment.commentid}">
		<div class="commentname">
			<div class="commentdate"><fmt:formatDate value="${comment.posted}" type="both" pattern="HH:mm E M/d/yyyy" /></div>
			<a href="Picture.jsp?pictureid=${picture.pictureid}#${comment.commentid}"><img src="/Artwork/Artists/${picture.dirname}/${fanart:encodeURI(picture.basename)}.s.jpg" /></a> by <a href="/Artists/${picture.dirname}/">${picture.artistname}</a>
		</div>
		<div class="commenttext <c:if test="${comment.deleted == true}">commentdeleted</c:if>" id="commenttext_${comment.commentid}">
			<c:set var="commenttext" value="${comment.comment}" />
			<table><tr><td>
			<%= formatText((String)pageContext.getAttribute("commenttext")) %>
			</td></tr></table>
			<div class="commentbuttons">
			<c:if test="${comment.deleted == false}"><button type="button" class="small" onClick="deleteComment(${picture.pictureid},${comment.commentid})">Delete</button></c:if>
			</div>
			<br clear="all" />
		</div>
		</div>
		</form>

		</c:forEach>
                
	</c:forEach>

</c:when>
<c:when test="${type == 'received'}">

	<div class="globalactionslink">
	<a href="javascript:nop()" onClick="markRead('comment','${showall}')">Mark all selected as read</a>
	</div>

	<div class="selectall"><input type="checkbox" name="selectall" onClick="toggleSelectAll(this)" /> Select all</div>

	<sql:query var="qryCommentsFull">
	SELECT * FROM comments,pictures
	WHERE comments.pictureid=pictures.pictureid
	AND pictures.artistid=?
	${showallclause}
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<c:set var="numItems" value="${qryCommentsFull.rowCount} " />
	<c:choose>
	<c:when test="${page > 0}"> 
	<c:set var="page" value="${page} " />
	</c:when>
	<c:otherwise>
	<c:set var="page" value="0 " />
	</c:otherwise>
	</c:choose>
	<%
	  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
	  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

	  Hashtable Pages = pagesLink(numItems,50,pageNum,true,"","text",request.getQueryString());

	  pageContext.setAttribute("offset",Pages.get("offset"));
	  pageContext.setAttribute("thispage",Pages.get("thispage"));
	  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
	%>

	<sql:query var="qryComments">
	SELECT * FROM comments,pictures,users
	LEFT JOIN artists ON artists.userid=users.userid
	WHERE comments.pictureid=pictures.pictureid
	AND comments.userid=users.userid
	AND pictures.artistid=?
	${showallclause}
	ORDER BY posted DESC
	LIMIT ${offset},${thispage}
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<%= Pages.get("pages") %>

	<c:forEach var="comment" items="${qryComments.rows}">

		<sql:query var="qryPictures">
		SELECT pictures.*,artists.artistname,artists.dirname FROM pictures,artists
		WHERE pictureid=?
		AND pictures.artistid=artists.artistid
		AND pictures.deleted IS NULL
		<sql:param value="${comment.pictureid}" />
		</sql:query>

		<c:forEach var="picture" items="${qryPictures.rows}">

		<form name="editcomment_${comment.commentid}">
		<div class="comment" id="comment_${comment.commentid}">
		<div class="commentname">
			<div class="commentdate"><fmt:formatDate value="${comment.posted}" type="both" pattern="HH:mm E M/d/yyyy" /></div>
			<c:if test="${comment.viewed == false}"><input type="checkbox" name="select_${comment.commentid}" id="select_${comment.commentid}" value="1" /></c:if>
			<c:choose>
			<c:when test="${comment.active == true}">
			<a href="/Artists/${comment.dirname}/">${comment.username}</a>
			</c:when>
			<c:otherwise>
			${comment.username}
			</c:otherwise>
			</c:choose>
			on <a href="Picture.jsp?pictureid=${picture.pictureid}#${comment.commentid}"><img src="/Artwork/Artists/${picture.dirname}/${fanart:encodeURI(picture.basename)}.s.jpg" /></a></div>
		<div class="commenttext clearAfter <c:if test="${comment.deleted == true}">commentdeleted</c:if>" id="commenttext_${comment.commentid}">
			<div class="commentprofilepic">
			<c:if test="${comment.profilepic > 0}">
				<c:choose>
				<c:when test="${comment.active == true}">
				<a href="/Artists/${comment.dirname}/"><img src="/profiles/${comment.profilepic}.s.${comment.profilepic_ext}" /></a>
				</c:when>
				<c:otherwise>
				<img src="/profiles/${comment.profilepic}.s.${comment.profilepic_ext}" />
				</c:otherwise>
				</c:choose>
			</c:if>
			</div>
			<c:set var="commenttext" value="${comment.comment}" />
			<table><tr><td>
			<%= formatText((String)pageContext.getAttribute("commenttext")) %>
			</td></tr></table>
			<div class="commentbuttons">
			<c:if test="${comment.deleted == false}"><button type="button" class="small" onClick="deleteComment(${picture.pictureid},${comment.commentid})">Delete</button></c:if>
			</div>
			<br clear="all" />
		</div>
		</div>
		</form>

		</c:forEach>

		<c:if test="${comment.viewed == false}">
		<script type="text/javascript">
		selitems.push(${comment.commentid});
		</script>
		</c:if>

	</c:forEach>

</c:when>
</c:choose>

</c:if>

{% endblock %}
