{% extends "artmanager/base.html" %}
{% load bbcode_tags %}

{% block am_content %}

<%--
inc_pending.jsp
ArtManager component for managing pending uploads. Linked from the Pictures component.
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" import="java.util.*,java.io.*" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fanart" uri="http://fanart.lionking.org/jsp/jstl/fanart" %>

<sql:setDataSource dataSource="jdbc/Fanart"   />

<c:if test="${loggedin == 1}">

<c:if test="${param.fnc == 'delete'}">

	<c:forEach var="deletepic" items="${fn:split(param.picturelist, ',')}">
		<c:set var="pic" value="0" />
		<c:catch var="catchException">
		<fmt:parseNumber var="pic" value="${deletepic}" integerOnly="true" />
		</c:catch>
		<c:if test="${pic > 0}">
			<sql:query var="qryPending">
			SELECT * FROM pending
			WHERE pendingid=?
			AND artistid=?
			<sql:param value="${pic}" />
			<sql:param value="${artist.artistid}" />
			</sql:query>

			<c:if test="${qryPending.rowCount > 0}">

				<c:set var="basepath" value="${basepath}" />
				<c:set var="pendingid" value="${deletepic}" />
				<c:set var="artistid" value="${artist.artistid}" />
				<sql:query var="qryDelPending">
				SELECT pendingid,extension FROM pending
				WHERE pendingid=?
				AND artistid=?
				<sql:param value="${pendingid}" />
				<sql:param value="${artist.artistid}" />
				</sql:query>
				<c:forEach var="delpending" items="${qryDelPending.rows}">
				<c:set var="ext" value="${delpending.extension}" />
				</c:forEach>
				<%
				        String basepath = (String)pageContext.getAttribute("basepath");
				        String artistid = (String)pageContext.getAttribute("artistid").toString();
				        String tempdir = basepath+"/upload";
				        String pendingid = (String)pageContext.getAttribute("pendingid").toString();
				        String ext = (String)pageContext.getAttribute("ext");
				        File f=new File(tempdir+"/FanArt."+pendingid+"."+artistid+"."+ext);
				        File ft=new File(tempdir+"/FanArt."+pendingid+"."+artistid+".s.jpg");
				        File fp=new File(tempdir+"/FanArt."+pendingid+"."+artistid+".p.jpg");
				        boolean flag;
				        flag = f.delete();
				        flag = ft.delete();
				        flag = fp.delete();
					printLog("Artist " + artistid + " deleted pending picture " + pendingid + ".");
				%>

				<sql:update var="updPending">
				DELETE FROM pending
				WHERE pendingid=?
				AND artistid=?
				<sql:param value="${pendingid}" />
				<sql:param value="${artist.artistid}" />
				</sql:update>

				Deleted ${deletepic}.

			</c:if>
		</c:if>

	</c:forEach>

</c:if>

<div class="am_altpagelink"><a class="button" href="ArtManager.jsp?op=upload">Upload Artwork</a></div>

<h2>Uploads Pending Approval</h2>

<div class="pageinfo">

<c:if test="${artist.autoapprove}">
<p>Because you have auto-approval privileges, the following pictures (unless flagged for excessive size or opted-in by you for manual approval)
will be moved into your Gallery and made public within ten minutes.</p>
</c:if>

</div>

<sql:query var="qryPending">
SELECT * FROM pending
WHERE artistid=?
ORDER BY uploaded ASC
<sql:param value="${artist.artistid}" />
</sql:query>

{% for pending in user.pending_set.all %}
<c:forEach var="pending" items="${qryPending.rows}">

{% include "includes/pending.html" %}

{% comment %}
<c:set var="filename" value="${pending.filename}" />
<div class="picture pendingpicture">
<table>
<tr>
<td class="thumb">
<a href="/upload/FanArt.${pending.pendingid}.${artist.artistid}.${pending.extension}" rel="shadowbox[pending]">
<c:choose>
<c:when test="${pending.ismovie == true}">
	<img class="thumb moviethumb" src="/images/movie_icon.gif" />
</c:when>
<c:otherwise>
	<img class="thumb" src="/upload/FanArt.${pending.pendingid}.${artist.artistid}.p.jpg" />
</c:otherwise>
</c:choose>
</a>
<div class="picturestats">
<fmt:formatDate value="${pending.uploaded}" type="both" pattern="E M/d/yyyy" /><br />
<c:if test="${pending.ismovie == false}">
${pending.width} x ${pending.height} <c:if test="${pending.width > maxwidth || pending.height > maxheight}">
<a href="javascript:nop()" class="previewPopupTrigger" type="msg" itemid="<c:choose><c:when test="${artist.autoapprove == true}">3</c:when><c:otherwise>1</c:otherwise></c:choose>"><img src="/images/warning.png" /></a>
</c:if><br />
</c:if>
<fmt:formatNumber value="${pending.filesize / 1024}" type="number" pattern="###" /> KB <c:if test="${pending.filesize > maxfilesize && pending.ismovie == false}">
<a href="javascript:nop()" class="previewPopupTrigger" type="msg" itemid="<c:choose><c:when test="${artist.autoapprove == true}">3</c:when><c:otherwise>2</c:otherwise></c:choose>"><img src="/images/warning.png" /></a>
</c:if><br />
</div>
</td>
<td class="fullwidth picturedetails">

<a href="javascript:nop()"><div class="actions_hover" id="actions_${pending.pendingid}">Actions</div></a>
<div class="actions_menu" id="actions_${pending.pendingid}_popup">
<h3>Actions</h3>
<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="setupEditPending(${pending.pendingid})">Edit</a>
<a class="ui-state-default ui-corner-all" href="javascript:nop()" onClick="deletePending(${pending.pendingid})">Delete</a>
</div>

<div class="picturedetails">

<div class="picadmininfo">
<c:set var="fnparts" value="${fn:split(pending.filename,'\\\\')}" />
${fnparts[fn:length(fnparts)-1]}
</div>

<div id="editpending_${pending.pendingid}">
<jsp:include page="/ajax_editpending.jsp?pendingid=${pending.pendingid}" />
</div>

<c:if test="${pending.replacement > 0}">
<div class="replacementpic">
<sql:query var="qryReplacePic">
SELECT * FROM pictures
WHERE pictureid=?
AND artistid=?
AND deleted IS NULL
<sql:param value="${pending.replacement}" />
<sql:param value="${artist.artistid}" />
</sql:query>
<c:forEach var="replacepic" items="${qryReplacePic.rows}">
Replacement for <a href="/Picture.jsp?pictureid=${pending.replacement}"><img src="/Artists/${artist.dirname}/${fanart:encodeURI(replacepic.basename)}.p.jpg" /></a>
</c:forEach>
</div>
</c:if>

</div>
</td>
</tr>
</table>
</div>
{% endcomment %}

<script type="text/javascript">
$('#actions_{{ pending.id }}').popupmenu({
    target: "#actions_{{ pending.id }}_popup",
    time: 300 });  
</script>

</c:forEach>
{% endfor %}

</c:if>

{% endblock %}
