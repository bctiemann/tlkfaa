{% extends "artmanager/base.html" %}
{% load bbcode_tags %}

{% block am_content %}

<%--
inc_fans.jsp
ArtManager component for listing your fans (users who have you in their faves).
--%>

<%@ include file="inc_root/inc_functions.jsp" %>
<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>

<sql:setDataSource dataSource="jdbc/Fanart"   />

<c:catch var="catchException">
<fmt:parseNumber var="page" value="${param.page}" integerOnly="true" />
</c:catch>

<c:if test="${loggedin == 1}">

<h2>Your Fans</h2>

<c:choose>
<c:when test="${param.sortby == 'name'}">
<c:set var="orderclause" value="ORDER BY username" />
<c:set var="sortby" value="name" />
</c:when>
<c:otherwise>
<c:set var="orderclause" value="ORDER BY added DESC" />
<c:set var="sortby" value="date" />
</c:otherwise>
</c:choose>

<sql:query var="qryFansAll">
SELECT * FROM favorites 
WHERE favorites.artistid=?
<sql:param value="${artist.artistid}" />
</sql:query>

<sql:query var="qryFansFull">
SELECT favorites.userid,
users.username,
added
FROM favorites 
LEFT JOIN artists ON favorites.userid=artists.userid 
LEFT JOIN users ON favorites.userid=users.userid 
WHERE favorites.artistid=?
AND visible=true
<sql:param value="${artist.artistid}" />
</sql:query>

<c:set var="numItems" value="${qryFansFull.rowCount} " />
<c:choose>
<c:when test="${page > 0}">
<c:set var="page" value="${page} " />
</c:when>
<c:otherwise>
<c:set var="page" value="1 " />
</c:otherwise>
</c:choose>
<%
  int numItems = Integer.parseInt(((String)pageContext.getAttribute("numItems")).trim());
  int pageNum = Integer.parseInt(((String)pageContext.getAttribute("page")).trim());

  Hashtable Pages = pagesLink(numItems,50,pageNum,false,"","text",request.getQueryString());

  pageContext.setAttribute("offset",Pages.get("offset"));
  pageContext.setAttribute("thispage",Pages.get("thispage"));
  pageContext.setAttribute("pagetotal",Pages.get("pagetotal"));
%>

<sql:query var="qryFans">
SELECT favorites.userid,users.username,dirname,added,profilepic,profilepic_ext,active
FROM favorites 
LEFT JOIN artists ON favorites.userid=artists.userid 
LEFT JOIN users ON favorites.userid=users.userid 
WHERE favorites.artistid=?
AND visible=true
${orderclause}
LIMIT ${offset},${thispage}
<sql:param value="${artist.artistid}" />
</sql:query>

<%= Pages.get("pages") %>

<div class="selector">
Sort by: 
<a class="<c:if test="${sortby == 'name'}">selected</c:if>" href="ArtManager.jsp?op=fans&sortby=name">name</a>
<a class="<c:if test="${sortby == 'date'}">selected</c:if>" href="ArtManager.jsp?op=fans&sortby=date">date added</a>
</div>

${qryFansAll.rowCount} fans total; ${qryFansFull.rowCount} visible.

<table class="users">
<c:forEach var="fan" items="${qryFans.rows}">

	<sql:query var="qryShouts">
	SELECT * FROM shouts
	WHERE userid=?
	AND artistid=?
	ORDER BY posted DESC
	LIMIT 1
	<sql:param value="${fan.userid}" />
	<sql:param value="${artist.artistid}" />
	</sql:query>

	<tr>
	<td class="profilepic">
	<c:if test="${fan.profilepic > 0}">
		<c:choose>
		<c:when test="${fan.active == true}">
		<a href="/Artists/${fan.dirname}/"><img class="userprofilepic" src="/profiles/${fan.profilepic}.s.${fan.profilepic_ext}" /></a>
		</c:when>
		<c:otherwise>
		<img src="/profiles/${fan.profilepic}.s.${fan.profilepic_ext}" />
		</c:otherwise>
		</c:choose>
	</c:if>
	</td>
	<td class="name">
	<c:choose>
	<c:when test="${fan.dirname != null}"><a href="/Artists/${fan.dirname}/">${fan.username}</a></c:when>
	<c:otherwise>${fan.username}</c:otherwise>
	</c:choose>
	</td>
	<td class="date"><fmt:formatDate value="${fan.added}" type="date" pattern="M/d/yyyy" /></td>
	<td class="comment">
	<c:if test="${qryShouts.rowCount > 0}">
	<c:forEach var="shout" items="${qryShouts.rows}">
	<c:set var="comment" value="${shout.comment}" />
	<%= formatText((String)pageContext.getAttribute("comment")) %>
	</c:forEach>
	</c:if>
	</td>
	</tr>

</c:forEach>
</table>

<%= Pages.get("pages") %>

</c:if>

{% endblock %}
