{% extends "fanart/base.html" %}
{% load bbcode_tags %}

{% block activetab_characters %}active{% endblock %}

{% block grass %}
{% include "fanart/grass_characters.html" %}
{% endblock %}

{% block body_prop %}tall{% endblock %}

{% block content %}

<%--
Characters/index.jsp
Main navigation page for viewing characters.
--%>

<jsp:include page="/inc_root/inc_header.jsp" />
<%@ include file="../inc_root/inc_functions.jsp" %>

<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<%@ taglib prefix="fanart" uri="http://fanart.lionking.org/jsp/jstl/fanart" %>

<sql:setDataSource dataSource="jdbc/Fanart" />

<c:catch var="catchException">
<fmt:parseNumber var="characterid" value="${param.characterid}" integerOnly="true" />
<fmt:parseNumber var="page" value="${param.page}" integerOnly="true" />
</c:catch>

<c:set var="count" value="50" />
<c:set var="querycount" value="${count + 1}" />

<c:set var="mode" value="canon" />
<c:if test="${param.mode == 'fan'}">
<c:set var="mode" value="fan" />
</c:if>
<c:if test="${param.mode == 'mosttagged'}">
<c:set var="mode" value="mosttagged" />
</c:if>
<c:if test="${param.mode == 'recentlytagged'}">
<c:set var="mode" value="recentlytagged" />
</c:if>
<c:if test="${page == null}">
<c:set var="page" value="1" />
</c:if>

<%--
<c:if test="${param.page > 0}">
<c:set var="page" value="${param.page}" />
</c:if>
--%>

<c:choose>
<c:when test="${characterid > 0}">

	<sql:query var="qryCharacter">
	SELECT characters.*,artists.artistname,artists.dirname FROM characters
	LEFT JOIN artists
	ON characters.artistid=artists.artistid
	WHERE characterid=?
	AND deleted IS NULL
	<sql:param value="${characterid}" />
	</sql:query>

<c:forEach var="character" items="${qryCharacter.rows}">

	<h1>{{ character.name }}</h1>

	<div class="featurebox">

	<div class="picture standalone">

	<c:choose>
	<%-- Canon --%>
        {% if character.creator == None %}
	<c:when test="${character.artistid == null}">

	        <c:set var="characterid" value="${character.characterid}" />
                <c:set var="basepath" value="${basepath}" />
		<%
		  List<String> extList = new ArrayList<String>();
                  extList.add("gif");
                  extList.add("jpg");
                  extList.add("png");
                  for (int i = 0; i < extList.size(); i++) {
                    File pic = new File(pageContext.getAttribute("basepath") + "/images/canon_characters/" + pageContext.getAttribute("characterid").toString() + "." + extList.get(i));
                    if (pic.exists()) {
                      pageContext.setAttribute("ext",extList.get(i));
                    }
                  }
		%>
		<img class="fullsize preview" id="thepicture" src="/images/canon_characters/${character.characterid}.${ext}" />

        </c:when>
        {% elif character.profile_picture %}
	<%-- Fan, with profile pic from gallery --%>
	<c:when test="${character.profilepic > 0}">

		<sql:query var="qryPicture">
		SELECT * FROM pictures
		WHERE pictureid=?
		<sql:param value="${character.profilepic}" />
		</sql:query>
		<c:forEach var="picture" items="${qryPicture.rows}">
			<a href="javascript:nop()" onClick="togglePicture(${picture.pictureid})" title="${picture.filename} by ${character.artistname}"><img class="fullsize preview" id="thepicture" src="/Artwork/Artists/${character.dirname}/${picture.filename}" /></a>
		</c:forEach>

	</c:when>
        {% elif character.coloring_profile_picture %}
	<%-- Fan, with profile pic from Coloring Cave --%>
	<c:when test="${character.profilepic_c > 0}">

		<sql:query var="qryCCPic">
		SELECT * FROM coloring_base,coloring_pics,artists
		WHERE coloring_pics.basepic=coloring_base.coloring_baseid
		AND coloring_base.artistid=artists.artistid
		AND coloring_pics.coloring_picid=?
		<sql:param value="${character.profilepic_c}" />
		</sql:query>
		<c:forEach var="picture" items="${qryCCPic.rows}">
			<a href="javascript:nop()" onClick="togglePicture()" title="${picture.filename} by ${character.artistname}"><img class="fullsize preview" id="thepicture" src="/Artwork/coloring/${picture.coloring_picid}.${picture.extension}" /></a>
			<c:if test="${character.artistid > 0}">
				<sql:query var="qryPicOrig">
				SELECT * FROM pictures
				WHERE pictureid=?
				<sql:param value="${picture.pictureid}" />
				</sql:query>
				<c:choose>
				<c:when test="${qryPicOrig.rowCount > 0}">
					<div class="directcaption">Colored line-art; <a href="/Picture.jsp?pictureid=${picture.pictureid}">see original by ${picture.artistname}</a></div>
				</c:when>
				<c:otherwise>
					<div class="directcaption">Colored line-art; original by <a href="/Artists/${picture.dirname}/">${picture.artistname}</a> no longer available</div>
				</c:otherwise>
				</c:choose>
			</c:if>
		</c:forEach>

	</c:when>
	</c:choose>
        {% endif %}

	<div class="pictureheading">

	<div class="picturestats">
	<ul>
	<li>
	<c:choose>
	<c:when test="${character.sex == 1}">Male</c:when>
	<c:when test="${character.sex == 2}">Female</c:when>
	</c:choose>
	{{ character.species }}</li>
	<li>{{ character.date_created|date:"H:i D n/j/Y" }}</li>
	{% if character.story_title %}
	<li>
        {% if character.story_url %}
	<c:choose>
	<c:when test="${character.storyurl != ''}">
		Source: <a target="_blank" href="${character.storyurl}">${character.storyname}</a>
	</c:when>
        {% else %}
	<c:otherwise>
		Source: ${character.storyname}
	</c:otherwise>
	</c:choose>
        {% endif %}
        {% endif %}
	</li>
	</c:if>
	<c:choose>
	<c:when test="${character.artistid == null}">
		<li><a href="/Characters/?mode=canon">All Canon Characters</a></li>
	</c:when>
	<c:otherwise>
		<li><a href="/Characters/?mode=fan&list=artist&term=${character.artistid}">All Characters owned by ${character.artistname}</a></li>
	</c:otherwise>
	</c:choose>
	</ul>
	</div>

	<c:choose>
	<c:when test="${character.artistid == null}">
		Canon
	</c:when>
	<c:otherwise>
		<div class="owner">Owner: <a href="/Artists/${character.dirname}/">${character.artistname}</a></div>
		<c:if test="${character.artistid != character.creator}">
			<sql:query var="qryCreator">
			SELECT * FROM artists
			WHERE artistid=?
			AND active=true
			AND enabled=true
			AND numpictures>0
			<sql:param value="${character.creator}" />
			</sql:query>
			<c:forEach var="creator" items="${qryCreator.rows}">
				<div class="creator">Created by <a href="/Artists/${creator.dirname}/">${creator.artistname}</a></div>
			</c:forEach>
		</c:if>
	</c:otherwise>
	</c:choose>

	</div>

	<div class="picturecaption">
	<h3>${character.charactername}</h3>
	<c:set var="chardesc" value="${character.description}" />
	<div class="characterdescr">
	<%= formatText((String)pageContext.getAttribute("chardesc")) %>
	</div>
	</div>

	<br clear="right" />

	<div class="othercharacters">

	<c:set var="otherchars" value="" />
	<c:set var="numotherchars" value="0" />
	<c:set var="filtertablesclause" value="" />
	<c:set var="filterpictureidclause" value="" />
	<c:set var="filtercharacteridclause" value="" />
	<c:if test="${param.othercharacters != null}">
		<c:forEach var="addchar" items="${fn:split(param.othercharacters, ',')}">
			<c:set var="c" value="0" />
			<c:catch var="catchException">
			<fmt:parseNumber var="c" value="${addchar}" integerOnly="true" />
			</c:catch>
			<c:if test="${c > 0 && numotherchars < 3}">
				<c:set var="numotherchars" value="${numotherchars+1}" />
				<c:if test="${otherchars != ''}">
					<c:set var="otherchars" value="${otherchars}," />
				</c:if>
				<c:set var="otherchars" value="${otherchars}${c}" />
				<c:set var="filtertablesclause" value="${filtertablesclause},picturecharacters as picturecharacters${c}" />
				<c:set var="filterpictureidclause" value="${filterpictureidclause} AND picturecharacters.pictureid=picturecharacters${c}.pictureid" />
				<c:set var="filtercharacteridclause" value="${filtercharacteridclause} AND picturecharacters${c}.characterid=${c}" />

				<sql:query var="qryOtherCharacter">
				SELECT characters.*,artistname,dirname,basename,extension
				FROM characters
				LEFT JOIN artists ON characters.artistid=artists.artistid
				LEFT JOIN pictures ON characters.profilepic=pictureid
				WHERE characterid=?
				AND characters.deleted IS NULL
				<sql:param value="${c}" />
				</sql:query>

				<c:forEach var="ocharacter" items="${qryOtherCharacter.rows}">
					<div class="offertile picturetile">
					<a href="/Characters/?characterid=${ocharacter.characterid}"><img class="characterpic" src="
					<c:choose>
					<c:when test="${ocharacter.artistid == null}">
						/images/canon_characters/${ocharacter.characterid}.s.jpg
					</c:when>
					<c:when test="${ocharacter.profilepic > 0}">
						/Artwork/Artists/${ocharacter.dirname}/${fanart:encodeURI(ocharacter.basename)}.s.jpg
					</c:when>
					<c:when test="${ocharacter.profilepic_c > 0}">
						/Artwork/coloring/${ocharacter.profilepic_c}.s.jpg
					</c:when>
					<c:otherwise>
						/images/blank_characterthumb.jpg
					</c:otherwise>
					</c:choose>" />
					</a>
					<a href="/Characters/?characterid=${ocharacter.characterid}">${ocharacter.charactername}</a><br />
					<c:choose><c:when test="${ocharacter.artistid == null}">(Canon)</c:when><c:otherwise><a href="/Artists/${ocharacter.dirname}/">${ocharacter.artistname}</a></c:otherwise></c:choose>
					<a href="javascript:nop()" onClick="filterCharacter(${c},'remove')">remove</a>
					</div>
				</c:forEach>

			</c:if>
		</c:forEach>
	</c:if>
	<c:set var="filtercharsclause" value="${filtercharsclause})" />
	<script type="text/javascript">
	var characterid = ${characterid};
	var otherchars = "${otherchars}";
	</script>

	</div>

	<c:if test="${numotherchars < 3}">

		<sql:query var="qryCharacterCanon">
		SELECT * FROM characters
		WHERE artistid IS NULL
		ORDER BY charactername
		</sql:query>

		With another character:
		<div class="tagcharacters">
		<table class="formtable tagcharacters">
		<tr>
		<td class="label">Canon</td>
		<td class="data"><select name="canoncharacter" id="canoncharacter_add" onChange="filterCharacter(this.options[this.selectedIndex].value,'add')">
		<option value="0">(Select)</option>
		<c:forEach var="character" items="${qryCharacterCanon.rows}">
		<option value="${character.characterid}">${character.charactername}</option>
		</c:forEach>
		</select>
		</td>
		</tr>
		<tr>
		<td class="label">Other</td>
		<td class="data"><input name="character" id="character_pick_add" onBlur="this.value=''" /></td>
		</tr>
		</table>
		</div>

	</c:if>


	<br clear="right" />
	<div id="offerslayout">

	<sql:query var="qryCharPics">
	SELECT pictures.*,artists.artistname,artists.dirname FROM pictures,artists,picturecharacters
	${filtertablesclause}
	WHERE pictures.pictureid=picturecharacters.pictureid
	${filterpictureidclause}
	AND picturecharacters.characterid=?
	AND pictures.artistid=artists.artistid
	${filtercharacteridclause}
	ORDER BY picturecharacters.tagged_on DESC
	LIMIT ${querycount}
	<sql:param value="${characterid}" />
	</sql:query>

<%--
	<sql:query var="qryCharPics">
	SELECT pictures.*,artists.artistname,artists.dirname FROM pictures,picturecharacters,artists
	WHERE picturecharacters.pictureid=pictures.pictureid
	AND pictures.artistid=artists.artistid
	AND picturecharacters.characterid=?
	<sql:param value="${character.characterid}" />
	</sql:query>
--%>

	<c:forEach var="charpic" items="${qryCharPics.rows}">

		<c:set var="thiscount" value="${thiscount+1}" />
		<c:choose>
		<c:when test="${thiscount <= count}">
<%--
		<sql:query var="qryCharPicDetails">
		SELECT * FROM pictures,artists
		WHERE pictures.artistid=artists.artistid
		AND pictures.pictureid=?
		<sql:param value="${charpic.pictureid}" />
		</sql:query>
--%>
<%--		<c:forEach var="charpicdetails" items="${qryCharPicDetails.rows}">--%>
			<div class="offertile picturetile">
			<a id="picturetile_${charpic.pictureid}" class="previewPopupTrigger" type="picture" itemid="${charpic.pictureid}" href="/Picture.jsp?pictureid=${charpic.pictureid}"><img class="" src="/Artwork/Artists/${charpic.dirname}/${fanart:encodeURI(charpic.basename)}.s.jpg" width="60" height="${charpic.thumbheight}" /></a>
			<a href="/Artists/${charpic.dirname}/">${charpic.artistname}</a>
			</div>
<%--		</c:forEach>--%>

		</c:when>
		<c:otherwise>

			<c:set var="showmorebutton" value="1" />

		</c:otherwise>
		</c:choose>

	</c:forEach>

	</div>

	<c:if test="${showmorebutton == 1}">
		<a class="button" href="/Artwork/?list=character&start=${count}&&term=${characterid}<c:if test="${otherchars != ''}">,${otherchars}</c:if>">More</a>
	</c:if>

	</div>

	</div>

</c:forEach>

{% endblock %}
