{% extends "fanart/base.html" %}
{% load picture_tags %}

{% block activetab_tradingtree %}active{% endblock %}

{% block grass %}
{% include "fanart/grass_tradingtree.html" %}
{% endblock %}

{% block body_prop %}tall{% endblock %}

{% block content %}

<%--
TradingTree.jsp
Allows artists to trade art in two forms: icons (the donor creates custom colored pictures per applicants' specifications), and
adoptables (donors post characters from their accounts, and other artists apply to take possession of them).
--%>

<jsp:include page="inc_root/inc_header.jsp" />
<%@ include file="inc_root/inc_functions.jsp" %>

<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="tags" tagdir="/WEB-INF/tags" %>

<sql:setDataSource dataSource="jdbc/Fanart" />

<c:catch var="catchException">
<fmt:parseNumber var="offerid" value="${param.offerid}" integerOnly="true" />
</c:catch>

<c:set var="offertype" value="icon" />
<c:if test="${param.offertype == 'adoptable'}">
<c:set var="offertype" value="adoptable" />
</c:if>

<c:choose>
<c:when test="${param.fnc == 'postnew'}">

</c:when>
<c:when test="${param.fnc == 'remove'}">

</c:when>
</c:choose>

<h1>Trading Tree</h1>

<div class="featurebox tradingtree">

<div class="selector">
<a class="{% if offer_type == "icon" %}selected{% endif %}" href="{% url "trading-tree" offer_type="icon" %}">icons</a>
<a class="{% if offer_type == "adoptable" %}selected{% endif %}" href="{% url "trading-tree" offer_type="adoptable" %}">adoptables</a>
</div>

{% if offer %}
<c:choose>
<c:when test="${offerid > 0}">

	<jsp:include page="/ajax_tradingtree.jsp?offerid=${offerid}" />

</c:when>
<c:otherwise>
{% else %}

	<sql:query var="qryClaimsMine">
	SELECT *
	FROM offers,artists,claims
	WHERE offers.artistid=artists.artistid
	AND claims.offerid=offers.offerid
	AND claims.userid=?
	AND visible=true
	<c:choose>
	<c:when test="${offertype == 'icon'}">
	AND (type='icon' AND fulfilled IS NULL AND claims.filename IS NOT NULL)
	</c:when>
	<c:when test="${offertype == 'adoptable'}">
	AND (type='adoptable' AND fulfilled IS NOT NULL)
	</c:when>
	</c:choose>
	${timelimitclause}
	${artistlimitclause}
	ORDER BY claims.posted
	<sql:param value="${user.userid}" />
	</sql:query>

        {% if offer_type == "icon" and user.icon_claims_ready.exists %}
	<c:if test="${qryClaimsMine.rowCount > 0}">
		<div class="newforme">
		<h3>New for You</h3>
		<jsp:include page="/inc_root/inc_ttforyou.jsp?offerype=${offertype}&showall=0" />
		</div>
	</c:if>
        {% elif offer_type == "adoptable" and user.adoptable_claims_ready.exists %}
	<c:if test="${qryClaimsMine.rowCount > 0}">
		<div class="newforme">
		<h3>New for You</h3>
		<jsp:include page="/inc_root/inc_ttforyou.jsp?offerype=${offertype}&showall=0" />
		</div>
	</c:if>
        {% endif %}


	<div id="offerslayout">

        {% for offer in offers %}

		<div class="offertile {% if user.is_authenticated %}{% applied_offer offer user %}{% endif %}">
		<a href="{% url "trading-tree" offer_type=offer_type %}?offer_id={{ offer.id }}"><img class="offer" src="{{ MEDIA_URL }}Artwork/offers/{{ offer.id_orig }}.s.jpg" width="120" height="{{ offer.thumb_height }}" /></a><br />
                {% if offer.artist %}
		    <a href="{% url "artist" dir_name=offer.artist.dir_name %}">{{ offer.artist.username|truncatechars:20 }}</a><br />
                {% endif %}
		{{ offer.title }}<br />
                {{ offer.date_posted|date:"H:i D n/j/Y" }}<br />
                {% if offer.type == "icon" %}
			{{ offer.tradingclaim_set.count }} request{{ offer.tradingclaim_set.count|pluralize }}, {{ offer.open_claims.count }} open
                {% elif offer.type == "adoptable" %}
                        {% if not offer.completed_claims.exists %}
                            {{ offer.tradingclaim_set.count }} applying
                        {% else %}
				Adopted.
                        {% endif %}
                {% endif %}
		</div>

        {% endfor %}

	<br clear="left" />

	</div>

</c:otherwise>
</c:choose>
{% endif %}

</div>

<jsp:include page="inc_root/inc_lowerlayout.jsp" />
<jsp:include page="inc_root/inc_footer.jsp" />

{% endblock %}
