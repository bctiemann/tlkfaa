{% extends "fanart/base.html" %}

{% block activetab_tradingtree %}active{% endblock %}

{% block grass %}
{% include "fanart/grass_tradingtree.html" %}
{% endblock %}

{% block body_prop %}tall{% endblock %}

{% block content %}

<%--
TradingTree.jsp
Allows artists to trade art in two forms: icons (the donor creates custom colored pictures per applicants' specifications), and
adoptables (donors post characters from their accounts, and other artists apply to take possession of them).
--%>

<jsp:include page="inc_root/inc_header.jsp" />
<%@ include file="inc_root/inc_functions.jsp" %>

<%@ page language="java" contentType="text/html; charset=UTF-8" %>

<%@ taglib prefix="sql" uri="http://java.sun.com/jsp/jstl/sql" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<%@ taglib prefix="tags" tagdir="/WEB-INF/tags" %>

<sql:setDataSource dataSource="jdbc/Fanart" />

<c:catch var="catchException">
<fmt:parseNumber var="offerid" value="${param.offerid}" integerOnly="true" />
</c:catch>

<c:set var="offertype" value="icon" />
<c:if test="${param.offertype == 'adoptable'}">
<c:set var="offertype" value="adoptable" />
</c:if>

<c:choose>
<c:when test="${param.fnc == 'postnew'}">

</c:when>
<c:when test="${param.fnc == 'remove'}">

</c:when>
</c:choose>

<h1>Trading Tree</h1>

<div class="featurebox tradingtree">

<div class="selector">
<a class="<c:if test="${offertype == 'icon'}">selected</c:if>" href="/TradingTree.jsp?offertype=icon">icons</a>
<a class="<c:if test="${offertype == 'adoptable'}">selected</c:if>" href="/TradingTree.jsp?offertype=adoptable">adoptables</a>
</div>

<c:choose>
<c:when test="${offerid > 0}">

	<jsp:include page="/ajax_tradingtree.jsp?offerid=${offerid}" />

</c:when>
<c:otherwise>

	<sql:query var="qryClaimsMine">
	SELECT *
	FROM offers,artists,claims
	WHERE offers.artistid=artists.artistid
	AND claims.offerid=offers.offerid
	AND claims.userid=?
	AND visible=true
	<c:choose>
	<c:when test="${offertype == 'icon'}">
	AND (type='icon' AND fulfilled IS NULL AND claims.filename IS NOT NULL)
	</c:when>
	<c:when test="${offertype == 'adoptable'}">
	AND (type='adoptable' AND fulfilled IS NOT NULL)
	</c:when>
	</c:choose>
	${timelimitclause}
	${artistlimitclause}
	ORDER BY claims.posted
	<sql:param value="${user.userid}" />
	</sql:query>
        
	<c:if test="${qryClaimsMine.rowCount > 0}">
		<div class="newforme">
		<h3>New for You</h3>
		<jsp:include page="/inc_root/inc_ttforyou.jsp?offerype=${offertype}&showall=0" />
		</div>
	</c:if>


	<div id="offerslayout">

	<sql:query var="qryOffers">
	SELECT *,artistname,dirname FROM offers,artists
	WHERE offers.artistid=artists.artistid
	AND type=?
	AND visible=true
	AND offers.active=true
	AND posted > DATE_SUB(NOW(),INTERVAL 3 MONTH)
	ORDER BY posted DESC
	<sql:param value="${offertype}" />
	</sql:query>

	<c:forEach var="offer" items="${qryOffers.rows}">

		<sql:query var="qryClaimsTotal">
		SELECT * FROM claims
		WHERE offerid=?
		<sql:param value="${offer.offerid}" />
		</sql:query>

		<sql:query var="qryClaimsMine">
		SELECT * FROM claims
		WHERE offerid=?
		AND userid=?
		<sql:param value="${offer.offerid}" />
		<sql:param value="${user.userid}" />
		</sql:query>

		<c:set var="artistname" value="${offer.artistname}" />
		<div class="offertile <c:if test="${qryClaimsMine.rowCount > 0}">offer_applied</c:if>">
		<a href="/TradingTree.jsp?offerid=${offer.offerid}&offertype=${offer.type}"><img class="offer" src="/Artwork/offers/${offer.offerid}.s.jpg" width="120" height="${offer.thumbheight}" /></a><br />
		<a href="/Artists/${offer.dirname}/"><%= truncateString((String)pageContext.getAttribute("artistname"),20) %></a><br />
		${offer.title}<br />
		<fmt:formatDate value="${offer.posted}" type="both" pattern="HH:mm E M/d/yyyy" /><br />
		<c:choose>
		<c:when test="${offer.type == 'icon'}">
			<sql:query var="qryClaimsOpen">
			SELECT * FROM claims
			WHERE offerid=?
			AND fulfilled IS NULL
			<sql:param value="${offer.offerid}" />
			</sql:query>
			${qryClaimsTotal.rowCount} requests, ${qryClaimsOpen.rowCount} open
		</c:when>
		<c:when test="${offer.type == 'adoptable'}">
			<sql:query var="qryAdopted">
			SELECT * FROM claims
			WHERE offerid=?
			AND fulfilled IS NOT NULL
			<sql:param value="${offer.offerid}" />
			</sql:query>
			<c:choose>
			<c:when test="${qryAdopted.rowCount == 0}">
				${qryClaimsTotal.rowCount} applying
			</c:when>
			<c:otherwise>
				Adopted.
			</c:otherwise>
			</c:choose>
		</c:when>
		</c:choose>
		</div>

	</c:forEach>

	<br clear="left" />

	</div>

</c:otherwise>
</c:choose>

</div>

<jsp:include page="inc_root/inc_lowerlayout.jsp" />
<jsp:include page="inc_root/inc_footer.jsp" />

{% endblock %}
